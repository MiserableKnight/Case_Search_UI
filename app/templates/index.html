<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>历史问题查询系统</title>
    <!-- 引入 Element UI -->
    <link rel="stylesheet" href="https://unpkg.com/element-ui/lib/theme-chalk/index.css">
    <style>
        body {
            margin: 0;
            padding: 0;
            background-color: #f5f7fa;
        }
        .container {
            max-width: 100%;
            margin: 0;
            padding: 0 20px 20px 20px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        .search-section {
            margin-bottom: 20px;
            padding: 20px;
            background-color: white;
            border-radius: 4px;
            box-shadow: 0 2px 12px 0 rgba(0,0,0,0.1);
            display: flex;
            gap: 20px;
        }
        .search-block {
            flex: 1;
            min-width: 0;
            border: 1px solid #EBEEF5;
            border-radius: 4px;
            padding: 15px;
        }
        .search-block.default-settings {
            flex: 0.67;  /* 将默认搜索设置区域的宽度从0.5增加到0.67 */
        }
        .search-block.keyword-search {
            flex: 1.83;    /* 将关键字搜索区域的宽度从2减少到1.83 */
        }
        .search-block.similarity-search {
            flex: 1;    /* 相似度搜索区域宽度保持不变 */
        }
        .block-title {
            font-size: 16px;
            color: #303133;
            margin-bottom: 15px;
            font-weight: bold;
        }
        .result-section {
            flex: 1;
            background-color: white;
            border-radius: 4px;
            box-shadow: 0 2px 12px 0 rgba(0,0,0,0.1);
            padding: 20px;
            margin-top: 20px;
        }
        .el-table {
            margin-top: 10px;
            font-size: 13px;
        }
        /* 添加自定义的表格行悬停效果 */
        .el-table__body tr:hover > td {
            background-color: #e6f1fc !important;  /* 更深的蓝色调背景 */
        }
        .result-info {
            margin: 10px 0;
            color: #606266;
            font-size: 14px;
            font-weight: bold;
        }
        h1 {
            margin-bottom: 20px;
            color: #303133;
        }
        .el-table__body-wrapper {
            overflow-y: auto;
        }
        .el-table th {
            font-size: 13px;
            padding: 4px 0;
        }
        .el-table td {
            padding: 2px 4px;
            font-size: 12px;
            vertical-align: top !important;
        }
        .el-table .cell {
            line-height: 18px;
            white-space: pre-wrap !important;
            height: auto !important;
            word-break: break-all;
            padding-top: 4px !important;
        }
        .search-cards {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .search-card {
            position: relative;   /* 恢复相对定位，这样卡片操作按钮可以相对它定位 */
            display: flex;        /* 保持水平排列 */
            align-items: center;  /* 保持垂直居中对齐 */
            gap: 10px;           /* 保持元素间距 */
            padding: 10px;
            background: white;
            border: 1px solid #EBEEF5;  /* 恢复边框样式 */
            border-radius: 4px;         /* 恢复圆角 */
        }
        .search-content {
            display: flex;
            align-items: center;
            gap: 20px;  /* 增加内部元素之间的间距 */
        }
        .search-inputs {
            display: flex;
            gap: 10px;
            align-items: center;
            flex: 1;  /* 让输入区域占满剩余空间 */
        }
        .search-controls {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-right: 40px;
        }
        .switch-with-label {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .switch-label {
            font-size: 13px;
            color: #606266;
        }
        .el-radio-group {
            display: flex;
            flex-direction: column;  /* 让单选按钮组垂直排列 */
            gap: 5px;               /* 控制按钮之间的间距 */
        }
        .search-content .el-radio {
            height: 24px;           /* 控制单选按钮的高度 */
            line-height: 24px;      /* 确保文字垂直居中 */
            margin-right: 0;        /* 移除右边距 */
        }
        .search-content .el-select {
            width: 120px;
            order: -1;  /* 让下拉框显示在最前面 */
        }
        .search-content .el-input {
            width: 300px;  /* 缩小输入框的固定宽度 */
        }
        .search-logic {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 10px;
        }
        .negative-filter {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .negative-text {
            font-size: 13px;
            color: #606266;
        }
        .card-actions {
            position: absolute;
            right: 5px;
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            gap: 5px;
        }
        .action-btn {
            padding: 4px 8px;  /* 增加内边距 */
            cursor: pointer;
            color: #909399;
            transition: all 0.3s;
            border: 1px solid #DCDFE6;  /* 添加边框 */
            border-radius: 4px;         /* 添加圆角 */
            background-color: #fff;     /* 添加背景色 */
        }
        .action-btn:hover {
            color: #409EFF;
            border-color: #409EFF;  /* 悬停时改变边框颜色 */
            background-color: #ecf5ff;  /* 悬停时添加背景色 */
        }
        .action-btn.delete:hover {
            color: #F56C6C;
            border-color: #F56C6C;
            background-color: #fef0f0;
        }
        .buttons-section {
            margin-top: 15px;
            display: flex;
            justify-content: center;
            gap: 10px;
        }
        .content-search {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .content-search .el-input {
            width: 100%;
        }
        .similarity-btn {
            align-self: flex-end;
        }
        .ai-summary {
            display: flex;
            flex-direction: column;
            gap: 10px;
            height: 100%;
        }
        .ai-summary .el-input {
            flex: 1;
        }
        .ai-input {
            height: 80px;
        }
        .ai-output {
            flex: 1;
            min-height: 120px;
        }
        .column-control {
            margin-bottom: 10px;
            display: flex;
            align-items: center;
        }
        .column-control .el-dropdown {
            margin-right: 10px;
        }
        .column-dropdown-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 5px 10px;
        }
        .column-dropdown-item .el-checkbox {
            margin-right: 0;
        }
        .search-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .statistics-controls {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 15px;
        }
        .axis-select {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .axis-label {
            font-size: 14px;
            color: #606266;
            width: 40px;
        }
        .axis-select .el-select {
            flex: 1;
        }
        .statistics-btn {
            width: 100%;
        }
        .default-search-controls {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        .control-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .control-label {
            font-size: 14px;
            color: #606266;
            width: 80px;
        }
        .control-item .el-select {
            flex: 1;
        }
    </style>
</head>
<body>
    <div id="app">
        <div class="container">
            <h1>历史问题查询系统</h1>
            
            <!-- 搜索区域 -->
            <div class="search-section">
                <!-- 关键字搜索 -->
                <div class="search-block keyword-search">
                    <div class="block-title">关键字搜索</div>
                    <div class="search-cards">
                        <div v-for="(level, idx) in searchLevels" :key="idx" class="search-card">
                            <div class="search-content">
                                <div class="search-inputs">
                                    <el-input v-model="level.keywords" placeholder="请输入关键字"></el-input>
                                    <el-select v-model="level.column_name" placeholder="搜索列">
                                        <el-option label="全部列" value="all"></el-option>
                                        <el-option
                                            v-for="col in dataSourceColumns[defaultSearch.dataSource]"
                                            :key="col"
                                            :label="col"
                                            :value="col">
                                        </el-option>
                                    </el-select>
                                </div>
                                <div class="search-controls">
                                    <el-radio-group v-model="level.logic">
                                        <el-radio label="and">与</el-radio>
                                        <el-radio label="or">或</el-radio>
                                    </el-radio-group>
                                    <div class="switch-with-label">
                                        <el-switch v-model="level.negative_filtering"></el-switch>
                                        <span class="switch-label">反向过滤</span>
                                    </div>
                                </div>
                            </div>
                            <div class="card-actions">
                                <span v-if="idx === 0" class="action-btn" @click="addLevel" title="添加搜索条件">
                                    <i class="el-icon-plus"></i>
                                </span>
                                <span v-if="idx > 0" class="action-btn delete" @click="removeLevel(idx)" title="删除">
                                    <i class="el-icon-close"></i>
                                </span>
                            </div>
                        </div>
                    </div>
                    <div class="buttons-section">
                        <el-button type="primary" @click="handleSearch">搜索</el-button>
                        <el-button @click="resetForm">重置</el-button>
                    </div>
                </div>

                <!-- 按内容搜索 -->
                <div class="search-block similarity-search">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <div class="block-title" style="margin-bottom: 0;">按相似度搜索</div>
                        <el-button type="primary" size="small" @click="showSearchColumnsDialog">
                            搜索范围设置<i class="el-icon-setting el-icon--right"></i>
                        </el-button>
                    </div>
                    <div class="content-search">
                        <el-input
                            type="textarea"
                            :rows="6"
                            placeholder="请输入要搜索的内容"
                            v-model="contentSearch.text">
                        </el-input>
                        <div style="text-align: right;">
                            <el-button type="primary" @click="handleSimilaritySearch" :disabled="!contentSearch.selectedColumns.length">
                                开始搜索
                            </el-button>
                        </div>
                    </div>
                </div>

                <!-- 数据统计 -->
                <div class="search-block default-settings">
                    <div class="block-title">默认搜索设置</div>
                    <div class="content-search">
                        <div class="default-search-controls">
                            <div class="control-item">
                                <span class="control-label">数据源：</span>
                                <el-button 
                                    type="primary" 
                                    size="small" 
                                    @click="showDataSourceDialog"
                                    style="width: 120px">
                                    [[ dataSourceOptions[defaultSearch.dataSource] ]]
                                </el-button>
                            </div>
                            <div class="control-item">
                                <span class="control-label">数据类型：</span>
                                <el-button 
                                    type="primary" 
                                    size="small" 
                                    @click="showDataTypesDialog"
                                    style="width: 120px">
                                    [[ defaultSearch.dataTypes.length ? `已选${defaultSearch.dataTypes.length}项` : '请选择' ]]
                                </el-button>
                            </div>
                            <div class="control-item">
                                <span class="control-label">机型：</span>
                                <el-button 
                                    type="primary" 
                                    size="small" 
                                    @click="showAircraftTypesDialog"
                                    style="width: 120px">
                                    [[ defaultSearch.aircraftTypes.length ? `已选${defaultSearch.aircraftTypes.length}项` : '请选择' ]]
                                </el-button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 结果区域 -->
            <div class="result-section" v-if="total > 0">
                <!-- 结果信息 -->
                <div class="result-info">
                    找到 [[ total ]] 条匹配记录
                </div>

                <!-- 结果表格 -->
                <div class="column-control">
                    <el-button type="primary" size="small" @click="showColumnDialog">
                        列显示控制<i class="el-icon-setting el-icon--right"></i>
                    </el-button>
                    <el-button type="success" size="small" @click="exportToCSV" :disabled="!searchResults.length">
                        导出CSV
                    </el-button>
                </div>

                <el-table
                    v-loading="loading"
                    :data="searchResults"
                    style="width: 100%"
                    size="mini">
                    <el-table-column
                        v-for="col in visibleColumns"
                        :key="col"
                        :prop="col"
                        :label="col"
                        :min-width="getColumnMinWidth(col)"
                        :width="getColumnFixedWidth(col)"
                        resizable>
                    </el-table-column>
                </el-table>
            </div>

            <!-- 所有对话框移到这里 -->
            <!-- 列显示控制对话框 -->
            <el-dialog title="列显示控制" :visible.sync="columnDialogVisible" width="300px">
                <div style="max-height: 400px; overflow-y: auto;">
                    <div style="margin-bottom: 15px; border-bottom: 1px solid #EBEEF5; padding-bottom: 10px;">
                        <el-checkbox 
                            v-model="selectAll" 
                            @change="handleSelectAllChange">
                            全选
                        </el-checkbox>
                    </div>
                    <el-checkbox-group v-model="selectedColumns" @change="handleSelectedChange">
                        <div v-for="col in columns" :key="col" style="margin-bottom: 10px;">
                            <el-checkbox :label="col">[[ col ]]</el-checkbox>
                        </div>
                    </el-checkbox-group>
                </div>
                <span slot="footer" class="dialog-footer">
                    <el-button @click="columnDialogVisible = false">取消</el-button>
                    <el-button type="primary" @click="applyColumnSettings">确定</el-button>
                </span>
            </el-dialog>

            <!-- 搜索范围设置对话框 -->
            <el-dialog title="搜索范围设置" :visible.sync="searchColumnsDialogVisible" width="300px">
                <div style="max-height: 400px; overflow-y: auto;">
                    <el-checkbox-group v-model="contentSearch.selectedColumns">
                        <div v-for="col in searchableColumns[defaultSearch.dataSource]" :key="col" style="margin-bottom: 10px;">
                            <el-checkbox :label="col">[[ col ]]</el-checkbox>
                        </div>
                    </el-checkbox-group>
                </div>
                <span slot="footer" class="dialog-footer">
                    <el-button @click="searchColumnsDialogVisible = false">取消</el-button>
                    <el-button type="primary" @click="applySearchColumnSettings">确定</el-button>
                </span>
            </el-dialog>

            <!-- 数据源选择对话框 -->
            <el-dialog title="选择数据源" :visible.sync="dataSourceDialogVisible" width="300px">
                <div style="max-height: 400px; overflow-y: auto;">
                    <el-radio-group v-model="defaultSearch.dataSource">
                        <div v-for="(label, value) in dataSourceOptions" :key="value" style="margin-bottom: 10px;">
                            <el-radio :label="value">
                                [[ label ]]
                            </el-radio>
                        </div>
                    </el-radio-group>
                </div>
                <span slot="footer" class="dialog-footer">
                    <el-button @click="dataSourceDialogVisible = false">取消</el-button>
                    <el-button type="primary" @click="applyDataSourceSettings">确定</el-button>
                </span>
            </el-dialog>

            <!-- 数据类型选择对话框 -->
            <el-dialog title="选择数据类型" :visible.sync="dataTypesDialogVisible" width="300px">
                <div style="max-height: 400px; overflow-y: auto;">
                    <div style="margin-bottom: 15px; border-bottom: 1px solid #EBEEF5; padding-bottom: 10px;">
                        <el-checkbox 
                            v-model="selectAllDataTypes" 
                            @change="handleSelectAllDataTypes">
                            全选
                        </el-checkbox>
                    </div>
                    <el-checkbox-group v-model="defaultSearch.dataTypes">
                        <div v-for="type in availableDataTypes" :key="type" style="margin-bottom: 10px;">
                            <el-checkbox :label="type">[[ type ]]</el-checkbox>
                        </div>
                    </el-checkbox-group>
                </div>
                <span slot="footer" class="dialog-footer">
                    <el-button @click="dataTypesDialogVisible = false">取消</el-button>
                    <el-button type="primary" @click="applyDataTypesSettings">确定</el-button>
                </span>
            </el-dialog>

            <!-- 机型选择对话框 -->
            <el-dialog title="选择机型" :visible.sync="aircraftTypesDialogVisible" width="300px">
                <div style="max-height: 400px; overflow-y: auto;">
                    <div style="margin-bottom: 15px; border-bottom: 1px solid #EBEEF5; padding-bottom: 10px;">
                        <el-checkbox 
                            v-model="selectAllAircraftTypes" 
                            @change="handleSelectAllAircraftTypes">
                            全选
                        </el-checkbox>
                    </div>
                    <el-checkbox-group v-model="defaultSearch.aircraftTypes">
                        <div v-for="type in aircraftTypeOptions" :key="type" style="margin-bottom: 10px;">
                            <el-checkbox :label="type">[[ type ]]</el-checkbox>
                        </div>
                    </el-checkbox-group>
                </div>
                <span slot="footer" class="dialog-footer">
                    <el-button @click="aircraftTypesDialogVisible = false">取消</el-button>
                    <el-button type="primary" @click="applyAircraftTypesSettings">确定</el-button>
                </span>
            </el-dialog>

            <!-- AI分析结果弹窗 -->
            <el-dialog
                title="AI分析结果"
                :visible.sync="aiDialogVisible"
                width="50%"
                :close-on-click-modal="false"
                :close-on-press-escape="false">
                <div style="max-height: 60vh; overflow-y: auto; white-space: pre-wrap; user-select: text;">
                    [[ aiResult ]]
                </div>
                <span slot="footer" class="dialog-footer">
                    <el-button type="primary" @click="aiDialogVisible = false">关闭</el-button>
                </span>
            </el-dialog>
        </div>
    </div>

    <!-- 引入 Vue 和 Element UI -->
    <script src="https://unpkg.com/vue@2/dist/vue.js"></script>
    <script src="https://unpkg.com/element-ui/lib/index.js"></script>
    <script src="https://unpkg.com/element-ui/lib/umd/locale/zh-CN.js"></script>
    <script>
        ELEMENT.locale(ELEMENT.lang.zhCN)
        
        new Vue({
            el: '#app',
            delimiters: ['[[', ']]'],
            data() {
                return {
                    searchLevels: [{
                        keywords: '',
                        column_name: 'all',
                        logic: 'and',
                        negative_filtering: false
                    }],
                    contentSearch: {
                        text: '',
                        selectedColumns: ['问题描述']
                    },
                    selectAll: false,  // 添加全选状态
                    aiInput: '',
                    loading: false,
                    searchResults: [],
                    total: 0,
                    columns: [],
                    columnVisible: {},
                    selectedColumns: [],  // 临时存储选中的列
                    columnDialogVisible: false,  // 控制对话框显示
                    aiDialogVisible: false,  // 控制AI结果弹窗显示
                    aiResult: '',  // 存储AI分析结果
                    defaultVisibleColumns: {
                        'case': ['申请时间', '问题描述', '答复详情', '飞机序列号/注册号/运营人'],
                        'engineering': ['发布时间', '文件名称', '原因和说明', '文件类型', 'MSN有效性'],  // 添加 MSN有效性
                        'manual': ['申请时间', '问题描述', '答复详情', '飞机序列号/注册号/运营人']
                    },
                    importantColumns: ['问题描述', '答复详情'],
                    compactColumns: ['ATA', '版本号', '机型', '数据类型'],  // 添加机型和数据类型到紧凑列
                    searchColumnsDialogVisible: false,  // 控制搜索范围设置对话框显示
                    searchableColumns: {
                        'case': ['标题', '问题描述', '答复详情', '客户期望'],
                        'engineering': ['文件名称', '原因和说明', '原文文本'],  // 添加工程文件的可搜索列
                        'manual': ['标题', '问题描述', '答复详情', '客户期望']
                    },
                    statistics: {
                        xAxis: '',
                        yAxis: ''
                    },
                    statisticsColumns: ['机型', 'ATA', '数据类型', '申请时间'],
                    defaultSearch: {
                        dataSource: 'case',
                        dataTypes: [],
                        aircraftTypes: ['ARJ21']
                    },
                    // 修改默认搜索列配置，使用正确的列名
                    defaultSearchColumn: {
                        'case': '问题描述',
                        'engineering': '原因和说明',  // 改回正确的列名
                        'manual': '问题描述'
                    },
                    // 修改 dataSourceTypes 对象
                    dataSourceTypes: {
                        'case': ['服务请求', '252问题', '客户请求'],
                        'engineering': ['SB', 'SL', 'FTAR', 'OIC', 'FIQS', 'OB', 'FOT'],
                        'manual': ['AMM', 'IPC', 'SRM']
                    },
                    availableDataTypes: [],  // 可选的数据类型列表
                    dataSourceColumns: {     // 各数据源对应的列
                        case: [],
                        engineering: [],
                        manual: []
                    },
                    dataSourceDialogVisible: false,  // 控制数据源选择对话框显示
                    selectAllDataTypes: false,  // 控制全选数据类型
                    dataTypesDialogVisible: false,  // 控制数据类型选择对话框显示
                    aircraftTypesDialogVisible: false,  // 控制机型选择对话框显示
                    selectAllAircraftTypes: false,  // 控制全选机型
                    dataSourceOptions: {
                        'case': '快响信息',
                        'engineering': '工程文件',
                        'manual': '手册'
                    },
                    aircraftTypeOptions: ['ARJ21', 'C919'],
                    tempDataSource: 'case',  // 添加这个属性用于临时存储旧的数据源
                }
            },
            computed: {
                visibleColumns() {
                    return this.columns.filter(col => this.columnVisible[col]);
                }
            },
            created() {
                this.initializeData();
            },
            methods: {
                async initializeData() {
                    try {
                        // 初始化数据源相关信息
                        await this.loadDataSourceColumns();
                        // 加载初始数据源的数据类型，但不显示提示
                        await this.loadInitialDataTypes();
                    } catch (error) {
                        console.error('初始化失败:', error);
                        this.$message.error('初始化失败：' + error);
                    }
                },
                async loadDataSourceColumns() {
                    try {
                        const response = await fetch('/api/data_source_columns');
                        const data = await response.json();
                        if (data.status === 'success') {
                            // 保存完整的列信息
                            this.dataSourceColumns = data.columns;
                            
                            // 对显示列进行过滤
                            const displayColumns = {};
                            const excludeColumns = ['机型', '数据类型'];
                            for (let source in data.columns) {
                                displayColumns[source] = data.columns[source].filter(col => !excludeColumns.includes(col));
                            }
                            
                            // 使用过滤后的列进行显示
                            this.columns = displayColumns[this.defaultSearch.dataSource];
                            
                            // 初始化列的可见性
                            this.columns.forEach(col => {
                                this.$set(this.columnVisible, col, this.defaultVisibleColumns[this.defaultSearch.dataSource].includes(col));
                            });
                        }
                    } catch (error) {
                        console.error('获取数据源列名失败:', error);
                        this.$message.error('获取数据源列名失败：' + error);
                    }
                },
                async loadInitialDataTypes() {
                    try {
                        const response = await fetch(`/api/data_types/${this.defaultSearch.dataSource}`);
                        const data = await response.json();
                        if (data.status === 'success') {
                            this.availableDataTypes = data.types;
                            this.defaultSearch.dataTypes = [...data.types];
                        } else {
                            // 如果API失败，使用备用数据
                            this.availableDataTypes = this.dataSourceTypes[this.defaultSearch.dataSource] || [];
                            this.defaultSearch.dataTypes = [...this.availableDataTypes];
                        }
                    } catch (error) {
                        console.error('初始化数据类型失败，使用备用数据:', error);
                        this.availableDataTypes = this.dataSourceTypes[this.defaultSearch.dataSource] || [];
                        this.defaultSearch.dataTypes = [...this.availableDataTypes];
                    }
                },
                async loadDataTypes() {
                    try {
                        const response = await fetch(`/api/data_types/${this.defaultSearch.dataSource}`);
                        const data = await response.json();
                        if (data.status === 'success') {
                            this.availableDataTypes = data.types;
                            // 默认全选数据类型
                            this.defaultSearch.dataTypes = [...this.availableDataTypes];
                        }
                    } catch (error) {
                        console.error('获取数据类型失败:', error);
                        this.$message.error('获取数据类型失败：' + error);
                    }
                },
                async handleDataSourceChange(value) {
                    try {
                        console.log('切换数据源到:', value);
                        
                        // 更新默认搜索列
                        const defaultColumn = this.defaultSearchColumn[value];
                        this.searchLevels.forEach(level => {
                            level.column_name = defaultColumn;
                        });

                        // 更新相似度搜索的默认选中列
                        if (value === 'engineering') {
                            this.contentSearch.selectedColumns = ['原因和说明'];  // 工程文件默认选中"原因和说明"
                        } else {
                            this.contentSearch.selectedColumns = ['问题描述'];    // 其他数据源默认选中"问题描述"
                        }

                        // 获取新数据源的数据类型
                        try {
                            const response = await fetch(`/api/data_types/${value}`);
                            const data = await response.json();
                            if (data.status === 'success') {
                                console.log('获取到的数据类型:', data.types);
                                this.availableDataTypes = data.types;
                                this.defaultSearch.dataTypes = [...data.types];
                                
                                // 更新列显示
                                await this.loadDataSourceColumns();
                                
                                // 清空搜索结果
                                this.searchResults = [];
                                this.total = 0;

                                // 使用 Element UI 的 Notification 组件显示更醒目的提示
                                this.$notify({
                                    title: '成功',
                                    message: `数据源已切换至${this.dataSourceOptions[value]}`,
                                    type: 'success',
                                    duration: 2000,
                                    position: 'top-right'
                                });
                            } else {
                                throw new Error('获取数据类型失败');
                            }
                        } catch (error) {
                            console.error('获取数据类型失败，使用备用数据:', error);
                            this.availableDataTypes = this.dataSourceTypes[value] || [];
                            this.defaultSearch.dataTypes = [...this.availableDataTypes];
                            
                            // 显示警告提示
                            this.$notify({
                                title: '警告',
                                message: '使用备用数据类型配置',
                                type: 'warning',
                                duration: 3000,
                                position: 'top-right'
                            });
                        }
                    } catch (error) {
                        console.error('切换数据源失败:', error);
                        // 显示错误提示
                        this.$notify.error({
                            title: '错误',
                            message: '切换数据源失败：' + error.message,
                            duration: 4000,
                            position: 'top-right'
                        });
                    }
                },
                handleAircraftTypeChange(values) {
                    // 不再影响关键字搜索的内容
                    console.log('机型选择已更新:', values);
                },
                getColumnMinWidth(column) {
                    // 工程文件的特殊处理
                    if (this.defaultSearch.dataSource === 'engineering') {
                        if (column === '原因和说明' || column === '原文文本') {
                            return '300';  // 这两列保持较宽
                        } else if (column === '相似度') {
                            return '80';  // 相似度列保持不变
                        } else if (column === 'MSN有效性') {
                            return '90';  // MSN有效性固定宽度，确保标题不换行
                        } else if (column === '文件名称') {
                            return '90';  // 文件名称至少和MSN有效性一样宽
                        } else if (column === '发布时间') {
                            return '90';  // 发布时间固定宽度，确保日期不换行
                        } else {
                            return '60';  // 其他列都设置最小宽度
                        }
                    }
                    
                    // 其他数据源的原有逻辑保持不变
                    if (column === '相似度') {
                        return '80';
                    } else if (column === '申请时间') {
                        return '90';
                    } else if (column === '问题描述' || column === '答复详情') {
                        return '300';
                    } else if (this.importantColumns.includes(column)) {
                        return '200';
                    }
                    return '100';
                },
                getColumnFixedWidth(column) {
                    // 工程文件的特殊处理
                    if (this.defaultSearch.dataSource === 'engineering') {
                        if (column === '原因和说明' || column === '原文文本') {
                            return null;  // 这两列使用自适应宽度
                        } else if (column === 'MSN有效性' || column === '发布时间' || column === '文件名称') {
                            return this.getColumnMinWidth(column);  // 这些列使用固定宽度
                        } else {
                            return '60';  // 其他列都使用最小固定宽度
                        }
                    }
                    
                    // 其他数据源的原有逻辑保持不变
                    if (this.compactColumns.includes(column)) {
                        return '60';
                    } else if (column === '相似度' || column === '申请时间') {
                        return this.getColumnMinWidth(column);
                    }
                    return null;
                },
                getColumns() {
                    console.log('开始获取列名');
                    fetch('/api/columns')
                        .then(response => response.json())
                        .then(data => {
                            console.log('获取到的列名:', data);
                            if (data.status === 'success') {
                                this.columns = data.columns;
                                // 初始化列的可见性
                                this.columns.forEach(col => {
                                    this.$set(this.columnVisible, col, this.defaultVisibleColumns[this.defaultSearch.dataSource].includes(col));
                                });
                            }
                        })
                        .catch(error => {
                            console.error('获取列名失败:', error);
                            this.$message.error('获取列名失败：' + error);
                        });
                },
                showColumnDialog() {
                    // 初始化选中的列
                    this.selectedColumns = this.visibleColumns;
                    this.columnDialogVisible = true;
                },
                applyColumnSettings() {
                    // 应用列设置
                    this.columns.forEach(col => {
                        this.$set(this.columnVisible, col, this.selectedColumns.includes(col));
                    });
                    this.columnDialogVisible = false;
                },
                addLevel() {
                    this.searchLevels.push({
                        keywords: '',
                        column_name: 'all',
                        logic: 'and',
                        negative_filtering: false
                    });
                },
                removeLevel(index) {
                    this.searchLevels.splice(index, 1);
                },
                handleSearch() {
                    console.log('开始搜索，搜索条件:', this.searchLevels);
                    if (!this.validateSearchLevels()) {
                        return;
                    }
                    this.loading = true;
                    
                    // 构建搜索请求数据
                    const searchData = {
                        search_levels: this.searchLevels,
                        data_source: this.defaultSearch.dataSource,
                        data_types: this.defaultSearch.dataTypes,
                        aircraft_types: this.defaultSearch.aircraftTypes
                    };
                    
                    console.log('发送的搜索数据:', searchData);
                    
                    fetch('/api/search', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(searchData)
                    })
                    .then(response => response.json())
                    .then(data => {
                        console.log('搜索结果:', data);
                        if (data.status === 'success') {
                            this.searchResults = data.data;
                            this.total = data.total;
                            if (this.total > 0) {
                                this.$message.success(`找到 ${this.total} 条匹配记录`);
                            } else {
                                this.$notify({
                                    title: '提示',
                                    message: '未找到匹配记录',
                                    type: 'warning'
                                });
                            }
                        } else {
                            // 显示错误提示
                            this.$notify.error({
                                title: '搜索失败',
                                message: data.message,
                                duration: 4000
                            });
                            // 清空搜索结果
                            this.searchResults = [];
                            this.total = 0;
                        }
                    })
                    .catch(error => {
                        console.error('搜索错误:', error);
                        this.$notify.error({
                            title: '搜索失败',
                            message: error.message || '搜索过程中发生错误',
                            duration: 4000
                        });
                        // 清空搜索结果
                        this.searchResults = [];
                        this.total = 0;
                    })
                    .finally(() => {
                        this.loading = false;
                    });
                },
                validateSearchLevels() {
                    let isValid = true;
                    this.searchLevels.forEach((level, index) => {
                        if (!level.keywords || !level.keywords.trim()) {
                            this.$message.warning(`第${index + 1}重搜索的关键字不能为空`);
                            isValid = false;
                        }
                    });
                    return isValid;
                },
                handleSimilaritySearch() {
                    if (!this.contentSearch.text.trim()) {
                        this.$message.warning('请输入要搜索的内容');
                        return;
                    }
                    if (!this.searchResults.length) {
                        this.$message.warning('请先执行关键字搜索获取结果');
                        return;
                    }
                    if (!this.contentSearch.selectedColumns.length) {
                        this.$message.warning('请选择搜索范围');
                        this.searchColumnsDialogVisible = false;
                        return;
                    }

                    this.loading = true;
                    const searchText = this.contentSearch.text.trim();

                    try {
                        // 发送相似度搜索请求到后端
                        fetch('/api/similarity', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                text: searchText,
                                columns: this.contentSearch.selectedColumns,
                                results: this.searchResults
                            })
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.status === 'success') {
                                // 更新搜索结果
                                this.searchResults = data.data;
                                
                                // 确保相似度列显示在表格中
                                if (!this.columns.includes('相似度')) {
                                    this.columns.unshift('相似度');
                                    this.$set(this.columnVisible, '相似度', true);
                                }
                                
                                this.$message.success(`已按相似度排序 ${this.searchResults.length} 条记录`);
                            } else {
                                this.$message.error(data.message);
                            }
                        })
                        .catch(error => {
                            console.error('相似度计算错误:', error);
                            this.$message.error('相似度计算失败：' + error.message);
                        })
                        .finally(() => {
                            this.loading = false;
                        });
                    } catch (error) {
                        console.error('相似度计算错误:', error);
                        this.$message.error('相似度计算失败：' + error.message);
                        this.loading = false;
                    }
                },
                handleStatistics() {
                    if (!this.searchResults.length) {
                        this.$message.warning('请先执行搜索获取结果');
                        return;
                    }
                    if (!this.statistics.xAxis || !this.statistics.yAxis) {
                        this.$message.warning('请选择统计维度');
                        return;
                    }
                    
                    // TODO: 这里添加统计逻辑
                    console.log('开始统计', this.statistics);
                    this.$message.info('统计功能开发中...');
                },
                resetForm() {
                    this.searchLevels = [{
                        keywords: '',
                        column_name: 'all',
                        logic: 'and',
                        negative_filtering: false
                    }];
                    this.contentSearch.text = '';
                    this.contentSearch.selectedColumns = ['问题描述'];
                    this.aiInput = '';
                    this.aiResult = '';
                    this.searchResults = [];
                    this.total = 0;
                    
                    // 移除相似度列
                    const similarityIndex = this.columns.indexOf('相似度');
                    if (similarityIndex > -1) {
                        this.columns.splice(similarityIndex, 1);
                        delete this.columnVisible['相似度'];
                    }
                },
                exportToCSV() {
                    const visibleCols = this.visibleColumns;
                    
                    let csvContent = '\uFEFF';
                    
                    csvContent += visibleCols.join(',') + '\n';
                    
                    this.searchResults.forEach(row => {
                        const rowData = visibleCols.map(col => {
                            let cellData = row[col] || '';
                            cellData = cellData.toString().replace(/"/g, '""');
                            if (cellData.includes(',') || cellData.includes('\n') || cellData.includes('"')) {
                                cellData = `"${cellData}"`;
                            }
                            return cellData;
                        });
                        csvContent += rowData.join(',') + '\n';
                    });
                    
                    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8' });
                    
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(blob);
                    link.download = `搜索结果_${new Date().toLocaleString()}.csv`;
                    
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    this.$message.success('导出成功');
                },
                showSearchColumnsDialog() {
                    this.searchColumnsDialogVisible = true;
                },
                applySearchColumnSettings() {
                    this.searchColumnsDialogVisible = false;
                },
                handleSelectAllChange(val) {
                    // 处理全选/取消全选
                    this.selectedColumns = val ? [...this.columns] : [];
                },
                handleSelectedChange(value) {
                    // 处理选中列变化
                    this.selectAll = value.length === this.columns.length;
                },
                showDataSourceDialog() {
                    // 记录打开对话框时的数据源，用于后续比较
                    this.tempDataSource = this.defaultSearch.dataSource;
                    this.dataSourceDialogVisible = true;
                },
                async applyDataSourceSettings() {
                    const oldDataSource = this.tempDataSource;  // 使用临时存储的旧数据源
                    const newDataSource = this.defaultSearch.dataSource;
                    this.dataSourceDialogVisible = false;
                    
                    if (oldDataSource !== newDataSource) {
                        try {
                            // 1. 先更新数据源相关数据
                            await this.updateDataSource(newDataSource);
                            
                            // 2. 如果更新成功，显示切换成功提示
                            this.$notify({
                                title: '成功',
                                message: `数据源已切换至${this.dataSourceOptions[newDataSource]}`,
                                type: 'success',
                                duration: 2000,
                                position: 'top-right'
                            });
                        } catch (error) {
                            // 如果更新失败，回退到原来的数据源
                            this.defaultSearch.dataSource = oldDataSource;
                            this.$notify.error({
                                title: '错误',
                                message: '切换数据源失败，已恢复原数据源',
                                duration: 3000,
                                position: 'top-right'
                            });
                        }
                    }
                },
                async updateDataSource(value) {
                    try {
                        // 1. 更新默认搜索列
                        const defaultColumn = this.defaultSearchColumn[value];
                        this.searchLevels.forEach(level => {
                            level.column_name = defaultColumn;
                        });

                        // 2. 更新相似度搜索的默认选中列
                        if (value === 'engineering') {
                            this.contentSearch.selectedColumns = ['原因和说明'];  // 工程文件默认选中"原因和说明"
                        } else {
                            this.contentSearch.selectedColumns = ['问题描述'];    // 其他数据源默认选中"问题描述"
                        }

                        // 3. 获取新数据源的数据类型
                        const response = await fetch(`/api/data_types/${value}`);
                        const data = await response.json();
                        if (data.status === 'success') {
                            this.availableDataTypes = data.types;
                            this.defaultSearch.dataTypes = [...data.types];
                        }

                        // 4. 更新列显示
                        await this.loadDataSourceColumns();
                        
                        // 5. 清空搜索结果
                        this.searchResults = [];
                        this.total = 0;
                    } catch (error) {
                        console.error('更新数据源失败:', error);
                        throw error;
                    }
                },
                showDataTypesDialog() {
                    this.selectAllDataTypes = this.defaultSearch.dataTypes.length === this.availableDataTypes.length;
                    this.dataTypesDialogVisible = true;
                },
                applyDataTypesSettings() {
                    // 保存之前的选择
                    const oldTypes = [...this.defaultSearch.dataTypes];
                    this.dataTypesDialogVisible = false;
                    
                    // 如果选择发生变化，可以在这里添加处理逻辑
                    if (JSON.stringify(oldTypes) !== JSON.stringify(this.defaultSearch.dataTypes)) {
                        // 可以触发搜索或其他操作
                        console.log('数据类型选择已更新:', this.defaultSearch.dataTypes);
                    }
                },
                showAircraftTypesDialog() {
                    this.selectAllAircraftTypes = this.defaultSearch.aircraftTypes.length === this.aircraftTypeOptions.length;
                    this.aircraftTypesDialogVisible = true;
                },
                applyAircraftTypesSettings() {
                    // 保存之前的选择
                    const oldTypes = [...this.defaultSearch.aircraftTypes];
                    this.aircraftTypesDialogVisible = false;
                    
                    // 如果选择发生变化，可以在这里添加处理逻辑
                    if (JSON.stringify(oldTypes) !== JSON.stringify(this.defaultSearch.aircraftTypes)) {
                        // 可以触发搜索或其他操作
                        console.log('机型选择已更新:', this.defaultSearch.aircraftTypes);
                    }
                },
                handleSelectAllDataTypes(val) {
                    this.defaultSearch.dataTypes = val ? [...this.availableDataTypes] : [];
                },
                handleSelectAllAircraftTypes(val) {
                    this.defaultSearch.aircraftTypes = val ? [...this.aircraftTypeOptions] : [];
                },
            }
        })
    </script>
</body>
</html> 