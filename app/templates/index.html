<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>历史问题查询系统</title>
    <!-- 引入 Element UI -->
    <link rel="stylesheet" href="https://unpkg.com/element-ui/lib/theme-chalk/index.css">
    <style>
        body {
            margin: 0;
            padding: 0;
            background-color: #f5f7fa;
        }
        .container {
            max-width: 100%;
            margin: 0;
            padding: 20px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        .search-section {
            margin-bottom: 20px;
            padding: 20px;
            background-color: white;
            border-radius: 4px;
            box-shadow: 0 2px 12px 0 rgba(0,0,0,0.1);
            display: flex;
            gap: 20px;
        }
        .search-block {
            flex: 1;
            min-width: 0;
            border: 1px solid #EBEEF5;
            border-radius: 4px;
            padding: 15px;
        }
        .search-block.default-settings {
            flex: 0.67;  /* 将默认搜索设置区域的宽度从0.5增加到0.67 */
        }
        .search-block.keyword-search {
            flex: 1.83;    /* 将关键字搜索区域的宽度从2减少到1.83 */
        }
        .search-block.similarity-search {
            flex: 1;    /* 相似度搜索区域宽度保持不变 */
        }
        .block-title {
            font-size: 16px;
            color: #303133;
            margin-bottom: 15px;
            font-weight: bold;
        }
        .result-section {
            flex: 1;
            background-color: white;
            border-radius: 4px;
            box-shadow: 0 2px 12px 0 rgba(0,0,0,0.1);
            padding: 20px;
            margin-top: 20px;
        }
        .el-table {
            margin-top: 10px;
            font-size: 13px;
        }
        /* 添加自定义的表格行悬停效果 */
        .el-table__body tr:hover > td {
            background-color: #e6f1fc !important;  /* 更深的蓝色调背景 */
        }
        .result-info {
            margin: 10px 0;
            color: #606266;
            font-size: 14px;
            font-weight: bold;
        }
        h1 {
            margin-bottom: 20px;
            color: #303133;
        }
        .el-table__body-wrapper {
            overflow-y: auto;
        }
        .el-table th {
            font-size: 13px;
            padding: 4px 0;
        }
        .el-table td {
            padding: 2px 4px;
            font-size: 12px;
            vertical-align: top !important;
        }
        .el-table .cell {
            line-height: 18px;
            white-space: pre-wrap !important;
            height: auto !important;
            word-break: break-all;
            padding-top: 4px !important;
        }
        .search-cards {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .search-card {
            position: relative;   /* 恢复相对定位，这样卡片操作按钮可以相对它定位 */
            display: flex;        /* 保持水平排列 */
            align-items: center;  /* 保持垂直居中对齐 */
            gap: 10px;           /* 保持元素间距 */
            padding: 10px;
            background: white;
            border: 1px solid #EBEEF5;  /* 恢复边框样式 */
            border-radius: 4px;         /* 恢复圆角 */
        }
        .search-content {
            display: flex;
            align-items: center;
            gap: 20px;  /* 增加内部元素之间的间距 */
        }
        .search-inputs {
            display: flex;
            gap: 10px;
            align-items: center;
            flex: 1;  /* 让输入区域占满剩余空间 */
        }
        .search-controls {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-right: 40px;
        }
        .switch-with-label {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .switch-label {
            font-size: 13px;
            color: #606266;
        }
        .el-radio-group {
            display: flex;
            flex-direction: column;  /* 让单选按钮组垂直排列 */
            gap: 5px;               /* 控制按钮之间的间距 */
        }
        .search-content .el-radio {
            height: 24px;           /* 控制单选按钮的高度 */
            line-height: 24px;      /* 确保文字垂直居中 */
            margin-right: 0;        /* 移除右边距 */
        }
        .search-content .el-select {
            width: 170px;  /* 从200px减少到170px */
            order: -1;
        }
        .search-content .el-input {
            width: 270px;  /* 从300px减少到270px */
        }
        .search-logic {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 10px;
        }
        .negative-filter {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .negative-text {
            font-size: 13px;
            color: #606266;
        }
        .card-actions {
            position: absolute;
            right: 5px;
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            gap: 5px;
        }
        .action-btn {
            padding: 4px 8px;  /* 增加内边距 */
            cursor: pointer;
            color: #909399;
            transition: all 0.3s;
            border: 1px solid #DCDFE6;  /* 添加边框 */
            border-radius: 4px;         /* 添加圆角 */
            background-color: #fff;     /* 添加背景色 */
        }
        .action-btn:hover {
            color: #409EFF;
            border-color: #409EFF;  /* 悬停时改变边框颜色 */
            background-color: #ecf5ff;  /* 悬停时添加背景色 */
        }
        .action-btn.delete:hover {
            color: #F56C6C;
            border-color: #F56C6C;
            background-color: #fef0f0;
        }
        .buttons-section {
            margin-top: 15px;
            display: flex;
            justify-content: center;
            gap: 10px;
        }
        .content-search {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .content-search .el-input {
            width: 100%;
        }
        .similarity-btn {
            align-self: flex-end;
        }
        .ai-summary {
            display: flex;
            flex-direction: column;
            gap: 10px;
            height: 100%;
        }
        .ai-summary .el-input {
            flex: 1;
        }
        .ai-input {
            height: 80px;
        }
        .ai-output {
            flex: 1;
            min-height: 120px;
        }
        .column-control {
            margin-bottom: 10px;
            display: flex;
            align-items: center;
        }
        .column-control .el-dropdown {
            margin-right: 10px;
        }
        .column-dropdown-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 5px 10px;
        }
        .column-dropdown-item .el-checkbox {
            margin-right: 0;
        }
        .search-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .statistics-controls {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 15px;
        }
        .axis-select {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .axis-label {
            font-size: 14px;
            color: #606266;
            width: 40px;
        }
        .axis-select .el-select {
            flex: 1;
        }
        .statistics-btn {
            width: 100%;
        }
        .default-search-controls {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        .control-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .control-label {
            font-size: 14px;
            color: #606266;
            width: 80px;
        }
        .control-item .el-select {
            flex: 1;
        }
        .result-count-container {
            display: flex;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .total-count {
            margin-right: 15px;
        }
        
        .type-statistics {
            display: flex;
            flex-wrap: wrap;
            font-size: 14px;
            color: #666;
        }
        
        .type-stat {
            margin-right: 15px;
            padding: 2px 8px;
            background-color: #f0f0f0;
            border-radius: 12px;
        }
        .el-table .narrow-column {
            width: auto !important;
            min-width: 50px !important;
        }
        
        /* 优化多选标签的样式 */
        .el-select__tags {
            max-width: calc(100% - 30px);
        }
        
        .el-select__tags-text {
            max-width: 100px;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        /* 添加新的样式用于选中行 */
        .el-table__body tr.selected-row td {
            background-color: #e6f1fc !important;
        }
        /* 保持鼠标悬停效果 */
        .el-table__body tr:hover > td {
            background-color: #e6f1fc !important;
        }
        /* 添加上传区域样式 */
        .upload-area {
            width: 100%;
        }
        .import-dialog-content {
            padding: 10px;
        }
        .import-source-select {
            display: flex;
            align-items: center;
        }
        .el-upload-dragger {
            width: 100%;
        }
        .el-upload__tip {
            margin-top: 10px;
            color: #909399;
        }
        .preview-area {
            margin-top: 20px;
        }
        .preview-stats {
            font-size: 14px;
            line-height: 1.8;
            color: #606266;
        }
        .preview-stats p {
            margin: 5px 0;
        }
        .import-source-select {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div id="app">
        <div class="container">
            <!-- 搜索区域 -->
            <div class="search-section">
                <!-- 关键字搜索 -->
                <div class="search-block keyword-search">
                    <div class="block-title">关键字搜索</div>
                    <div class="search-cards">
                        <div v-for="(level, idx) in searchLevels" :key="idx" class="search-card">
                            <div class="search-content">
                                <div class="search-inputs">
                                    <el-input v-model="level.keywords" placeholder="请输入关键字"></el-input>
                                    <el-select v-model="level.column_name" 
                                               multiple 
                                               collapse-tags 
                                               placeholder="选择搜索列"
                                               @change="handleColumnSelectChange($event, level)">
                                        <!-- 添加全选选项 -->
                                        <el-option
                                            key="__select_all__"
                                            label="全选"
                                            value="__select_all__">
                                        </el-option>
                                        <!-- 原有的列选项 -->
                                        <el-option
                                            v-for="col in dataSourceColumns[defaultSearch.dataSource]"
                                            :key="col"
                                            :label="col"
                                            :value="col">
                                        </el-option>
                                    </el-select>
                                </div>
                                <div class="search-controls">
                                    <el-radio-group v-model="level.logic">
                                        <el-radio label="and">与</el-radio>
                                        <el-radio label="or">或</el-radio>
                                    </el-radio-group>
                                    <div class="switch-with-label">
                                        <el-switch v-model="level.negative_filtering"></el-switch>
                                        <span class="switch-label">反向过滤</span>
                                    </div>
                                </div>
                            </div>
                            <div class="card-actions">
                                <span v-if="idx === 0" class="action-btn" @click="addLevel" title="添加搜索条件">
                                    <i class="el-icon-plus"></i>
                                </span>
                                <span v-if="idx > 0" class="action-btn delete" @click="removeLevel(idx)" title="删除">
                                    <i class="el-icon-close"></i>
                                </span>
                            </div>
                        </div>
                    </div>
                    <div class="buttons-section">
                        <el-button type="primary" @click="handleSearch">搜索</el-button>
                        <el-button @click="resetForm">重置</el-button>
                    </div>
                </div>

                <!-- 按内容搜索 -->
                <div class="search-block similarity-search">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <div class="block-title" style="margin-bottom: 0;">按相似度搜索</div>
                        <el-button type="primary" size="small" @click="showSearchColumnsDialog">
                            搜索范围设置<i class="el-icon-setting el-icon--right"></i>
                        </el-button>
                    </div>
                    <div class="content-search">
                        <el-input
                            type="textarea"
                            :rows="6"
                            placeholder="请输入要搜索的内容"
                            v-model="contentSearch.text">
                        </el-input>
                        <div style="text-align: right;">
                            <el-button type="primary" @click="handleSimilaritySearch" :disabled="!contentSearch.selectedColumns.length">
                                开始搜索
                            </el-button>
                        </div>
                    </div>
                </div>

                <!-- 数据统计 -->
                <div class="search-block default-settings">
                    <div class="block-title">默认搜索设置</div>
                    <div class="content-search">
                        <div class="default-search-controls">
                            <div class="control-item">
                                <span class="control-label">数据导入：</span>
                                <el-button 
                                    type="primary" 
                                    size="small" 
                                    @click="showImportDialog"
                                    style="width: 120px">
                                    导入数据<i class="el-icon-upload el-icon--right"></i>
                                </el-button>
                            </div>
                            <div class="control-item">
                                <span class="control-label">数据源：</span>
                                <el-button 
                                    type="primary" 
                                    size="small" 
                                    @click="showDataSourceDialog"
                                    style="width: 120px">
                                    [[ dataSourceOptions[defaultSearch.dataSource] ]]
                                </el-button>
                            </div>
                            <div class="control-item">
                                <span class="control-label">数据类型：</span>
                                <el-button 
                                    type="primary" 
                                    size="small" 
                                    @click="showDataTypesDialog"
                                    style="width: 120px">
                                    [[ defaultSearch.dataTypes.length ? `已选${defaultSearch.dataTypes.length}项` : '请选择' ]]
                                </el-button>
                            </div>
                            <div class="control-item">
                                <span class="control-label">机型：</span>
                                <el-button 
                                    type="primary" 
                                    size="small" 
                                    @click="showAircraftTypesDialog"
                                    style="width: 120px">
                                    [[ defaultSearch.aircraftTypes.length ? `已选${defaultSearch.aircraftTypes.length}项` : '请选择' ]]
                                </el-button>
                            </div>
                            <div class="control-item">
                                <span class="control-label">敏感词：</span>
                                <el-button 
                                    type="primary" 
                                    size="small" 
                                    @click="showSensitiveWordDialog"
                                    style="width: 120px">
                                    管理敏感词<i class="el-icon-edit el-icon--right"></i>
                                </el-button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 结果区域 -->
            <div class="result-section" v-if="total > 0">
                <!-- 结果信息 -->
                <div class="result-info">
                    <div class="result-count-container">
                        <span class="total-count">找到 [[ total ]] 条匹配记录</span>
                        <div class="type-statistics" v-if="typeStatistics && Object.keys(typeStatistics).length > 0">
                            <span v-for="(count, type) in typeStatistics" :key="type" class="type-stat">
                                [[ type ]]: [[ count ]]条
                            </span>
                        </div>
                    </div>
                </div>

                <!-- 结果表格 -->
                <div class="column-control">
                    <el-button type="primary" size="small" @click="showColumnDialog">
                        列显示控制<i class="el-icon-setting el-icon--right"></i>
                    </el-button>
                    <el-button type="warning" size="small" @click="anonymizeResults">
                        脱敏显示
                    </el-button>
                    <el-button type="primary" size="small" @click="exportToCsv" :disabled="!selectedRows.length">
                        导出CSV
                    </el-button>
                    <el-button type="primary" size="small" @click="analyzeSelectedData" :disabled="!selectedRows.length">
                        数据分析
                    </el-button>
                </div>

                <el-table
                    ref="dataTable"
                    v-loading="loading"
                    :data="searchResults"
                    style="width: 100%"
                    size="mini"
                    :row-class-name="getRowClass"
                    @row-click="handleRowClick"
                    @selection-change="handleSelectionChange">
                    <el-table-column
                        type="selection"
                        width="55">
                    </el-table-column>
                    <el-table-column
                        label="序号"
                        prop="序号"
                        width="40"
                        fixed>
                    </el-table-column>
                    <el-table-column
                        v-for="col in visibleColumns"
                        :key="col"
                        :prop="col"
                        :label="col"
                        :min-width="getColumnMinWidth(col)"
                        :width="col === '相似度' ? '70' : getColumnFixedWidth(col)"
                        :class="{'narrow-column': col === '机型' || col === '数据类型'}"
                        resizable>
                    </el-table-column>
                </el-table>
            </div>

            <!-- 所有对话框移到这里 -->
            <!-- 列显示控制对话框 -->
            <el-dialog title="列显示控制" :visible.sync="columnDialogVisible" width="300px">
                <div style="max-height: 400px; overflow-y: auto;">
                    <div style="margin-bottom: 15px; border-bottom: 1px solid #EBEEF5; padding-bottom: 10px;">
                        <el-checkbox 
                            v-model="selectAll" 
                            @change="handleSelectAllChange">
                            全选
                        </el-checkbox>
                    </div>
                    <el-checkbox-group v-model="selectedColumns" @change="handleSelectedChange">
                        <div v-for="col in columns" :key="col" style="margin-bottom: 10px;">
                            <el-checkbox :label="col">[[ col ]]</el-checkbox>
                        </div>
                    </el-checkbox-group>
                </div>
                <span slot="footer" class="dialog-footer">
                    <el-button @click="columnDialogVisible = false">取消</el-button>
                    <el-button type="primary" @click="applyColumnSettings">确定</el-button>
                </span>
            </el-dialog>

            <!-- 搜索范围设置对话框 -->
            <el-dialog title="搜索范围设置" :visible.sync="searchColumnsDialogVisible" width="300px">
                <div style="max-height: 400px; overflow-y: auto;">
                    <el-checkbox-group v-model="contentSearch.selectedColumns">
                        <div v-for="col in searchableColumns[defaultSearch.dataSource]" :key="col" style="margin-bottom: 10px;">
                            <el-checkbox :label="col">[[ col ]]</el-checkbox>
                        </div>
                    </el-checkbox-group>
                </div>
                <span slot="footer" class="dialog-footer">
                    <el-button @click="searchColumnsDialogVisible = false">取消</el-button>
                    <el-button type="primary" @click="applySearchColumnSettings">确定</el-button>
                </span>
            </el-dialog>

            <!-- 数据源选择对话框 -->
            <el-dialog title="选择数据源" :visible.sync="dataSourceDialogVisible" width="300px">
                <div style="max-height: 400px; overflow-y: auto;">
                    <el-radio-group v-model="defaultSearch.dataSource">
                        <div v-for="(label, value) in dataSourceOptions" :key="value" style="margin-bottom: 10px;">
                            <el-radio :label="value">
                                [[ label ]]
                            </el-radio>
                        </div>
                    </el-radio-group>
                </div>
                <span slot="footer" class="dialog-footer">
                    <el-button @click="dataSourceDialogVisible = false">取消</el-button>
                    <el-button type="primary" @click="applyDataSourceSettings">确定</el-button>
                </span>
            </el-dialog>

            <!-- 数据类型选择对话框 -->
            <el-dialog title="选择数据类型" :visible.sync="dataTypesDialogVisible" width="300px">
                <div style="max-height: 400px; overflow-y: auto;">
                    <div style="margin-bottom: 15px; border-bottom: 1px solid #EBEEF5; padding-bottom: 10px;">
                        <el-checkbox 
                            v-model="selectAllDataTypes" 
                            @change="handleSelectAllDataTypes">
                            全选
                        </el-checkbox>
                    </div>
                    <el-checkbox-group v-model="defaultSearch.dataTypes">
                        <div v-for="type in availableDataTypes" :key="type" style="margin-bottom: 10px;">
                            <el-checkbox :label="type">[[ type ]]</el-checkbox>
                        </div>
                    </el-checkbox-group>
                </div>
                <span slot="footer" class="dialog-footer">
                    <el-button @click="dataTypesDialogVisible = false">取消</el-button>
                    <el-button type="primary" @click="applyDataTypesSettings">确定</el-button>
                </span>
            </el-dialog>

            <!-- 机型选择对话框 -->
            <el-dialog title="选择机型" :visible.sync="aircraftTypesDialogVisible" width="300px">
                <div style="max-height: 400px; overflow-y: auto;">
                    <div style="margin-bottom: 15px; border-bottom: 1px solid #EBEEF5; padding-bottom: 10px;">
                        <el-checkbox 
                            v-model="selectAllAircraftTypes" 
                            @change="handleSelectAllAircraftTypes">
                            全选
                        </el-checkbox>
                    </div>
                    <el-checkbox-group v-model="defaultSearch.aircraftTypes">
                        <div v-for="type in aircraftTypeOptions" :key="type" style="margin-bottom: 10px;">
                            <el-checkbox :label="type">[[ type ]]</el-checkbox>
                        </div>
                    </el-checkbox-group>
                </div>
                <span slot="footer" class="dialog-footer">
                    <el-button @click="aircraftTypesDialogVisible = false">取消</el-button>
                    <el-button type="primary" @click="applyAircraftTypesSettings">确定</el-button>
                </span>
            </el-dialog>

            <!-- AI分析结果弹窗 -->
            <el-dialog
                title="AI分析结果"
                :visible.sync="aiDialogVisible"
                width="50%"
                :close-on-click-modal="false"
                :close-on-press-escape="false">
                <div style="max-height: 60vh; overflow-y: auto; white-space: pre-wrap; user-select: text;">
                    [[ aiResult ]]
                </div>
                <span slot="footer" class="dialog-footer">
                    <el-button type="primary" @click="aiDialogVisible = false">关闭</el-button>
                </span>
            </el-dialog>

            <!-- 敏感词管理对话框 -->
            <el-dialog title="敏感词管理" 
                       :visible.sync="sensitiveWordDialogVisible" 
                       width="525px"
                       style="margin-top: 5vh">
                <div class="sensitive-word-manager">
                    <!-- 添加新词区域 -->
                    <div class="add-word-section">
                        <el-form :inline="true">
                            <el-form-item label="新增敏感词">
                                <el-input v-model="newWord" placeholder="输入敏感词" style="width: 160px"></el-input>
                            </el-form-item>
                            <el-form-item label="类别">
                                <el-select v-model="selectedCategory" style="width: 160px">
                                    <el-option v-for="cat in categories"
                                             :key="cat"
                                             :label="categoryLabels[cat]"
                                             :value="cat">
                                    </el-option>
                                </el-select>
                            </el-form-item>
                            <el-form-item>
                                <el-button type="primary" @click="addSensitiveWord">添加</el-button>
                            </el-form-item>
                        </el-form>
                    </div>
                    
                    <!-- 敏感词列表 -->
                    <div class="sensitive-word-list">
                        <el-tabs v-model="activeCategory">
                            <el-tab-pane v-for="cat in categories"
                                        :key="cat"
                                        :label="categoryLabels[cat]"
                                        :name="cat">
                                <el-table :data="sensitiveWords[cat]" 
                                         size="mini"
                                        max-height="200px"
                                        :cell-style="{ padding: '0px' }"
                                        :header-cell-style="{ padding: '2px' }"
                                        style="margin-bottom: 10px; font-size: 12px;">
                                    <el-table-column prop="word" label="敏感词"></el-table-column>
                                    <el-table-column width="60" align="center">
                                        <template slot-scope="scope">
                                            <el-button type="danger" 
                                                     size="mini" 
                                                     style="padding: 3px 6px; font-size: 11px;"
                                                     @click="removeSensitiveWord(scope.row.word, cat)">
                                                删除
                                            </el-button>
                                        </template>
                                    </el-table-column>
                                </el-table>
                            </el-tab-pane>
                        </el-tabs>
                    </div>
                </div>
            </el-dialog>

            <!-- 数据导入对话框 -->
            <el-dialog 
                title="数据导入" 
                :visible.sync="importDialogVisible" 
                width="500px"
                :close-on-click-modal="false"
                :close-on-press-escape="false">
                <div class="import-dialog-content">
                    <!-- 数据源选择 -->
                    <div class="import-source-select" style="margin-bottom: 20px;">
                        <span style="margin-right: 10px;">选择数据源：</span>
                        <el-radio-group v-model="importSettings.dataSource">
                            <el-radio v-for="(label, value) in dataSourceOptions" 
                                     :key="value" 
                                     :label="value">
                                [[ label ]]
                            </el-radio>
                        </el-radio-group>
                    </div>

                    <!-- 文件上传区域 -->
                    <el-upload
                        class="upload-area"
                        drag
                        action="/api/import_data"
                        :data="{ dataSource: importSettings.dataSource }"
                        :before-upload="handleBeforeUpload"
                        :on-success="handleUploadSuccess"
                        :on-error="handleUploadError"
                        :show-file-list="false"
                        :multiple="false">
                        <i class="el-icon-upload"></i>
                        <div class="el-upload__text">
                            将文件拖到此处，或<em>点击选择文件</em>
                        </div>
                        <div class="el-upload__tip" slot="tip">
                            支持上传 .xlsx, .xls, .csv 格式的文件
                        </div>
                    </el-upload>

                    <!-- 预览区域 -->
                    <div v-if="importSettings.previewData" class="preview-area" style="margin-top: 20px;">
                        <el-card class="preview-info">
                            <div slot="header">
                                <span style="font-weight: bold">数据预览</span>
                            </div>
                            <div class="preview-stats">
                                <p>原有数据：[[ importSettings.previewData.original_count ]] 条</p>
                                <p>上传数据：[[ importSettings.previewData.uploaded_count ]] 条</p>
                                <p>重复数据：[[ importSettings.previewData.duplicate_count ]] 条</p>
                                <p>实际新增：[[ importSettings.previewData.new_count ]] 条</p>
                                <p>变更后数据：[[ importSettings.previewData.final_count ]] 条</p>
                            </div>
                        </el-card>
                    </div>
                </div>
                <div slot="footer" class="dialog-footer">
                    <el-button @click="cancelImport">取消</el-button>
                    <el-button 
                        type="primary" 
                        @click="confirmImport"
                        :disabled="!importSettings.previewData">
                        确认导入
                    </el-button>
                </div>
            </el-dialog>
        </div>
    </div>

    <!-- 引入 Vue 和 Element UI -->
    <script src="https://unpkg.com/vue@2/dist/vue.js"></script>
    <script src="https://unpkg.com/element-ui/lib/index.js"></script>
    <script src="https://unpkg.com/element-ui/lib/umd/locale/zh-CN.js"></script>
    <script>
        ELEMENT.locale(ELEMENT.lang.zhCN)
        
        new Vue({
            el: '#app',
            delimiters: ['[[', ']]'],
            data() {
                return {
                    searchLevels: [{
                        keywords: '',
                        column_name: ['问题描述'],
                        logic: 'and',
                        negative_filtering: false
                    }],
                    contentSearch: {
                        text: '',
                        selectedColumns: ['问题描述']
                    },
                    selectAll: false,
                    aiInput: '',
                    loading: false,
                    searchResults: [],
                    total: 0,
                    columns: [],
                    columnVisible: {},
                    selectedColumns: [],
                    columnDialogVisible: false,
                    aiDialogVisible: false,
                    aiResult: '',
                    defaultVisibleColumns: {
                        'case': ['申请时间', '问题描述', '答复详情', '机号/MSN', '运营人'],
                        'engineering': ['发布时间', '文件名称', '原因和说明', '文件类型', 'MSN有效性'],
                        'manual': ['申请时间', '问题描述', '答复详情', '飞机序列号/注册号/运营人'],
                        'faults': ['日期', '问题描述', '排故措施', '运营人', '飞机序列号', '机号']
                    },
                    importantColumns: ['问题描述', '答复详情'],
                    compactColumns: ['ATA', '版本号', '机型', '数据类型'],
                    searchColumnsDialogVisible: false,
                    searchableColumns: {
                        'case': ['标题', '问题描述', '答复详情', '客户期望'],
                        'engineering': ['文件名称', '原因和说明', '原文文本'],
                        'manual': ['标题', '问题描述', '答复详情', '客户期望'],
                        'faults': ['问题描述', '排故措施']
                    },
                    statistics: {
                        xAxis: '',
                        yAxis: ''
                    },
                    statisticsColumns: ['机型', 'ATA', '数据类型', '申请时间'],
                    defaultSearch: {
                        dataSource: 'case',
                        dataTypes: [],
                        aircraftTypes: ['ARJ21', '无']
                    },
                    defaultSearchColumn: {
                        'case': '问题描述',
                        'engineering': '原因和说明',
                        'manual': '问题描述',
                        'faults': '问题描述'
                    },
                    dataSourceTypes: {
                        'case': ['服务请求', '252问题', '客户请求'],
                        'engineering': ['SB', 'SL', 'FTAR', 'OIC', 'FIQS', 'OB', 'FOT'],
                        'manual': ['AMM', 'IPC', 'SRM'],
                        'faults': ['故障报告', '部件拆换记录']
                    },
                    availableDataTypes: [],
                    dataSourceColumns: {
                        case: [],
                        engineering: [],
                        manual: [],
                        faults: []
                    },
                    dataSourceDialogVisible: false,
                    selectAllDataTypes: false,
                    dataTypesDialogVisible: false,
                    aircraftTypesDialogVisible: false,
                    selectAllAircraftTypes: false,
                    dataSourceOptions: {
                        'case': '快响信息',
                        'engineering': '工程文件',
                        'manual': '手册',
                        'faults': '故障报告'
                    },
                    aircraftTypeOptions: ['ARJ21', 'C919', '无'],
                    tempDataSource: 'case',
                    sensitiveWordDialogVisible: false,
                    newWord: '',
                    selectedCategory: 'organizations',
                    categories: ['organizations', 'aircraft', 'locations', 'other'],
                    categoryLabels: {
                        organizations: '组织机构',
                        aircraft: '设备型号',
                        locations: '地点',
                        other: '其他'
                    },
                    activeCategory: 'organizations',
                    sensitiveWords: {
                        organizations: [],
                        aircraft: [],
                        locations: [],
                        other: []
                    },
                    typeStatistics: {},
                    selectedRows: [],
                    lastClickedRowIndex: null,  // 添加这一行来记录上次点击的行索引
                    importDialogVisible: false,
                    importSettings: {
                        dataSource: 'case',
                        previewData: null,
                        uploadedFile: null
                    }
                }
            },
            computed: {
                visibleColumns() {
                    // 移除原有的故障报告特殊处理逻辑
                    if (this.columns.includes('相似度')) {
                        // 确保相似度列在第一位
                        const cols = this.columns.filter(col => this.columnVisible[col]);
                        if (cols.includes('相似度')) {
                            cols.splice(cols.indexOf('相似度'), 1);
                            return ['相似度', ...cols];
                        }
                        return cols;
                    }
                    // 如果没有相似度列，返回所有可见列
                    return this.columns.filter(col => this.columnVisible[col]);
                },
            },
            created() {
                this.initializeData();
            },
            methods: {
                async initializeData() {
                    try {
                        // 初始化数据源相关信息
                        await this.loadDataSourceColumns();
                        
                        // 确保初始搜索列为"问题描述"
                        if (this.defaultSearch.dataSource === 'case') {
                            this.searchLevels.forEach(level => {
                                level.column_name = ['问题描述'];  // 修改为数组形式
                            });
                        }
                        
                        // 加载初始数据源的数据类型
                        await this.loadInitialDataTypes();
                    } catch (error) {
                        console.error('初始化失败:', error);
                        this.$message.error('初始化失败：' + error);
                    }
                },
                async loadDataSourceColumns() {
                    try {
                        const response = await fetch('/api/data_source_columns');
                        const data = await response.json();
                        if (data.status === 'success' && data.columns) {
                            // 保存完整的列信息
                            this.dataSourceColumns = data.columns;
                            
                            // 确保当前数据源的列信息存在
                            if (!this.dataSourceColumns[this.defaultSearch.dataSource]) {
                                throw new Error(`未找到数据源 ${this.defaultSearch.dataSource} 的列信息`);
                            }
                            
                            // 初始化列的可见性
                            this.columns = this.dataSourceColumns[this.defaultSearch.dataSource];
                            this.columns.forEach(col => {
                                this.$set(this.columnVisible, col, this.defaultVisibleColumns[this.defaultSearch.dataSource].includes(col));
                            });
                            
                            // 确保每个搜索层级的 column_name 都有有效的值
                            const defaultColumn = this.defaultSearchColumn[this.defaultSearch.dataSource];
                            this.searchLevels.forEach(level => {
                                if (!Array.isArray(level.column_name) || !level.column_name.length) {
                                    level.column_name = [defaultColumn];
                                }
                            });
                        } else {
                            throw new Error('获取数据源列名失败：返回数据格式不正确');
                        }
                    } catch (error) {
                        console.error('获取数据源列名失败:', error);
                        // 使用备用数据
                        if (this.defaultVisibleColumns[this.defaultSearch.dataSource]) {
                            this.columns = this.defaultVisibleColumns[this.defaultSearch.dataSource];
                            this.columns.forEach(col => {
                                this.$set(this.columnVisible, col, true);
                            });
                        }
                        this.$message.error('获取数据源列名失败：' + error.message);
                    }
                },
                async loadInitialDataTypes() {
                    try {
                        const response = await fetch(`/api/data_types/${this.defaultSearch.dataSource}`);
                        const data = await response.json();
                        if (data.status === 'success') {
                            this.availableDataTypes = data.types;
                            this.defaultSearch.dataTypes = [...data.types];
                        } else {
                            // 如果API失败，使用备用数据
                            this.availableDataTypes = this.dataSourceTypes[this.defaultSearch.dataSource] || [];
                            this.defaultSearch.dataTypes = [...this.availableDataTypes];
                        }
                    } catch (error) {
                        console.error('初始化数据类型失败，使用备用数据:', error);
                        this.availableDataTypes = this.dataSourceTypes[this.defaultSearch.dataSource] || [];
                        this.defaultSearch.dataTypes = [...this.availableDataTypes];
                    }
                },
                async loadDataTypes() {
                    try {
                        const response = await fetch(`/api/data_types/${this.defaultSearch.dataSource}`);
                        const data = await response.json();
                        if (data.status === 'success') {
                            this.availableDataTypes = data.types;
                            // 默认全选数据类型
                            this.defaultSearch.dataTypes = [...this.availableDataTypes];
                        }
                    } catch (error) {
                        console.error('获取数据类型失败:', error);
                        this.$message.error('获取数据类型失败：' + error);
                    }
                },
                async handleDataSourceChange(value) {
                    try {
                        console.log('切换数据源到:', value);
                        
                        // 更新默认搜索列
                        const defaultColumn = this.defaultSearchColumn[value];
                        if (!defaultColumn) {
                            throw new Error(`未找到数据源 ${value} 的默认搜索列`);
                        }
                        
                        this.searchLevels.forEach(level => {
                            level.column_name = [defaultColumn];
                        });

                        // 更新相似度搜索的默认选中列
                        this.contentSearch.selectedColumns = value === 'engineering' ? ['原因和说明'] : ['问题描述'];

                        // 获取新数据源的数据类型
                        await this.loadDataTypes();
                        
                        // 更新列显示
                        await this.loadDataSourceColumns();
                        
                        // 清空搜索结果
                        this.searchResults = [];
                        this.total = 0;

                        this.$notify({
                            title: '成功',
                            message: `数据源已切换至${this.dataSourceOptions[value]}`,
                            type: 'success',
                            duration: 2000
                        });
                    } catch (error) {
                        console.error('切换数据源失败:', error);
                        this.$notify.error({
                            title: '错误',
                            message: '切换数据源失败：' + error.message,
                            duration: 3000
                        });
                        
                        // 恢复到之前的数据源
                        this.defaultSearch.dataSource = this.tempDataSource;
                    }
                },
                handleAircraftTypeChange(values) {
                    // 不再影响关键字搜索的内容
                    console.log('机型选择已更新:', values);
                },
                getColumnMinWidth(column) {
                    // 快响信息(case)的特殊处理
                    if (this.defaultSearch.dataSource === 'case') {
                        if (column === '故障发生日期' || column === '申请时间') {
                            return '90';  // 日期类列宽度调整
                        } else if (column === '问题描述' || column === '答复详情') {
                            return '300';
                        } else if (column === '相似度') {
                            return '70';
                        } else if (column === '机型') {
                            return '70';
                        } else if (column === '数据类型') {
                            return '80';
                        } else if (column === '机号/MSN' || column === '运营人') {
                            return '100';  // 新增列的宽度设置
                        } else {
                            return '90';
                        }
                    }
                    
                    // 工程文件的特殊处理
                    if (this.defaultSearch.dataSource === 'engineering') {
                        if (column === '原因和说明' || column === '原文文本') {
                            return '300';  // 这两列保持较宽
                        } else if (column === '相似度') {
                            return '70';  // 相似度列调整为70px
                        } else if (column === 'MSN有效性') {
                            return '90';  // MSN有效性固定宽度，确保标题不换行
                        } else if (column === '文件名称') {
                            return '90';  // 文件名称至少和MSN有效性一样宽
                        } else if (column === '发布时间') {
                            return '90';  // 发布时间固定宽度，确保日期不换行
                        } else {
                            return '60';  // 其他列都设置最小宽度
                        }
                    }
                    
                    // 其他数据源的默认处理
                    if (column === '相似度') {
                        return '70';
                    } else if (column === '问题描述' || column === '答复详情') {
                        return '300';
                    } else if (this.importantColumns.includes(column)) {
                        return '200';
                    }
                    return '100';
                },
                getColumnFixedWidth(column) {
                    // 快响信息(case)的特殊处理
                    if (this.defaultSearch.dataSource === 'case') {
                        if (column === '机型') {
                            return '70';  // 改为70px，与 getColumnMinWidth 保持一致
                        } else if (column === '数据类型') {
                            return '80';  // 保持不变
                        }
                    }
                    
                    // 工程文件的特殊处理
                    if (this.defaultSearch.dataSource === 'engineering') {
                        if (column === '原因和说明' || column === '原文文本') {
                            return null;  // 这两列使用自适应宽度
                        } else if (column === 'MSN有效性' || column === '发布时间' || column === '文件名称') {
                            return this.getColumnMinWidth(column);  // 这些列使用固定宽度
                        }
                    }
                    return null;  // 其他列使用自适应宽度
                },
                getColumns() {
                    console.log('开始获取列名');
                    fetch('/api/columns')
                        .then(response => response.json())
                        .then(data => {
                            console.log('获取到的列名:', data);
                            if (data.status === 'success') {
                                this.columns = data.columns;
                                // 初始化列的可见性
                                this.columns.forEach(col => {
                                    this.$set(this.columnVisible, col, this.defaultVisibleColumns[this.defaultSearch.dataSource].includes(col));
                                });
                            }
                        })
                        .catch(error => {
                            console.error('获取列名失败:', error);
                            this.$message.error('获取列名失败：' + error);
                        });
                },
                showColumnDialog() {
                    // 初始化选中的列
                    this.selectedColumns = this.visibleColumns;
                    
                    // 对于故障报告数据源，确保关键列在对话框中默认被选中
                    if (this.defaultSearch.dataSource === 'faults') {
                        const essentialColumns = ['日期', '问题描述', '排故措施', '飞机序列号/机号/运营人'];  // 移除 '维修ATA'
                        essentialColumns.forEach(col => {
                            if (this.columns.includes(col) && !this.selectedColumns.includes(col)) {
                                this.selectedColumns.push(col);
                            }
                        });
                    }
                    
                    this.columnDialogVisible = true;
                },
                applyColumnSettings() {
                    // 应用列设置
                    this.columns.forEach(col => {
                        this.$set(this.columnVisible, col, this.selectedColumns.includes(col));
                    });
                    
                    // 对于故障报告数据源，确保关键列始终可见
                    if (this.defaultSearch.dataSource === 'faults') {
                        const essentialColumns = ['日期', '问题描述', '排故措施', '飞机序列号/机号/运营人'];
                        essentialColumns.forEach(col => {
                            if (this.columns.includes(col)) {
                                this.$set(this.columnVisible, col, true);
                            }
                        });
                    }
                    
                    this.columnDialogVisible = false;
                },
                addLevel() {
                    this.searchLevels.push({
                        keywords: '',
                        column_name: ['问题描述'],
                        logic: 'and',
                        negative_filtering: false
                    });
                },
                removeLevel(index) {
                    this.searchLevels.splice(index, 1);
                },
                handleSearch() {
                    console.log('开始搜索，搜索条件:', this.searchLevels);
                    if (!this.validateSearchLevels()) {
                        return;
                    }
                    this.loading = true;
                    
                    // 移除相似度列
                    const similarityIndex = this.columns.indexOf('相似度');
                    if (similarityIndex > -1) {
                        this.columns.splice(similarityIndex, 1);
                        delete this.columnVisible['相似度'];
                    }
                    
                    // 构建搜索请求数据
                    const searchData = {
                        search_levels: this.searchLevels,
                        data_source: this.defaultSearch.dataSource,
                        data_types: this.defaultSearch.dataTypes,
                        aircraft_types: this.defaultSearch.aircraftTypes
                    };
                    
                    console.log('发送的搜索数据:', searchData);
                    
                    fetch('/api/search', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(searchData)
                    })
                    .then(response => response.json())
                    .then(data => {
                        console.log('搜索结果:', data);
                        if (data.status === 'success') {
                            this.searchResults = data.data;
                            
                            // 处理故障报告数据源的日期格式
                            if (this.defaultSearch.dataSource === 'faults') {
                                this.searchResults = this.searchResults.map(item => {
                                    // 处理日期字段的格式
                                    if (item['日期']) {  // 使用正确的日期列名
                                        try {
                                            const dateStr = item['日期'];
                                            // 处理GMT格式的日期
                                            if (dateStr.includes('GMT')) {
                                                const date = new Date(dateStr);
                                                item['日期'] = date.getFullYear() + '-' + 
                                                    String(date.getMonth() + 1).padStart(2, '0') + '-' + 
                                                    String(date.getDate()).padStart(2, '0');
                                            } 
                                            // 处理其他格式的日期
                                            else {
                                                const date = new Date(dateStr);
                                                if (!isNaN(date.getTime())) {
                                                    item['日期'] = date.getFullYear() + '-' + 
                                                        String(date.getMonth() + 1).padStart(2, '0') + '-' + 
                                                        String(date.getDate()).padStart(2, '0');
                                                }
                                            }
                                        } catch (e) {
                                            console.warn('日期格式化失败:', item['日期']);
                                        }
                                    }
                                    return item;
                                });
                            }
                            
                            this.total = data.total;
                            if (this.total > 0) {
                                this.$message.success(`找到 ${this.total} 条匹配记录`);
                            } else {
                                this.$notify({
                                    title: '提示',
                                    message: '未找到匹配记录',
                                    type: 'warning'
                                });
                            }
                            this.typeStatistics = this.countResultsByType(this.searchResults);
                        } else {
                            // 显示错误提示
                            this.$notify.error({
                                title: '搜索失败',
                                message: data.message,
                                duration: 4000
                            });
                            // 清空搜索结果
                            this.searchResults = [];
                            this.total = 0;
                        }
                    })
                    .catch(error => {
                        console.error('搜索错误:', error);
                        this.$notify.error({
                            title: '搜索失败',
                            message: error.message || '搜索过程中发生错误',
                            duration: 4000
                        });
                        // 清空搜索结果
                        this.searchResults = [];
                        this.total = 0;
                    })
                    .finally(() => {
                        this.loading = false;
                        this.selectedRows = [];
                    });
                },
                validateSearchLevels() {
                    let isValid = true;
                    this.searchLevels.forEach((level, index) => {
                        if (!level.keywords || !level.keywords.trim()) {
                            this.$message.warning(`第${index + 1}重搜索的关键字不能为空`);
                            isValid = false;
                        }
                    });
                    return isValid;
                },
                handleSimilaritySearch() {
                    if (!this.contentSearch.text.trim()) {
                        this.$message.warning('请输入要搜索的内容');
                        return;
                    }
                    if (!this.searchResults.length) {
                        this.$message.warning('请先执行关键字搜索获取结果');
                        return;
                    }
                    if (!this.contentSearch.selectedColumns.length) {
                        this.$message.warning('请选择搜索范围');
                        this.searchColumnsDialogVisible = false;
                        return;
                    }

                    this.loading = true;
                    const searchText = this.contentSearch.text.trim();
                    
                    // 构建请求数据
                    const requestData = {
                        text: searchText,
                        columns: this.contentSearch.selectedColumns,
                        results: this.searchResults
                    };
                    
                    console.log('发送相似度计算请求:', requestData);

                    // 发送相似度搜索请求到后端
                    fetch('/api/similarity', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(requestData)
                    })
                    .then(response => {
                        console.log('服务器响应状态:', response.status, response.statusText);
                        
                        // 检查响应状态
                        if (!response.ok) {
                            // 如果响应不是200-299之间，先尝试解析JSON
                            return response.text().then(text => {
                                console.log('非200响应内容:', text);
                                try {
                                    // 尝试将响应解析为JSON
                                    const data = JSON.parse(text);
                                    throw new Error(data.message || '相似度计算失败');
                                } catch (e) {
                                    // 如果不是JSON，可能是HTML错误页面
                                    if (text.includes('<!doctype')) {
                                        console.error('服务器返回了HTML错误页面');
                                        throw new Error('服务器内部错误(500)，请检查服务器日志');
                                    }
                                    throw new Error(text || '相似度计算失败');
                                }
                            });
                        }
                        return response.json();
                    })
                    .then(data => {
                        console.log('相似度计算结果:', data);
                        if (data.status === 'success') {
                            // 更新搜索结果
                            this.searchResults = data.data;
                            
                            // 确保相似度列显示在表格中
                            if (!this.columns.includes('相似度')) {
                                this.columns.unshift('相似度');
                                this.$set(this.columnVisible, '相似度', true);
                            }
                            
                            this.$message.success(`已按相似度排序 ${this.searchResults.length} 条记录`);
                            this.typeStatistics = this.countResultsByType(this.searchResults);
                        } else {
                            throw new Error(data.message || '相似度计算失败');
                        }
                    })
                    .catch(error => {
                        console.error('相似度计算错误:', error);
                        this.$notify.error({
                            title: '相似度计算失败',
                            message: error.message || '服务器响应异常',
                            duration: 4000,
                            type: 'error'
                        });
                    })
                    .finally(() => {
                        this.loading = false;
                    });
                },
                handleStatistics() {
                    if (!this.searchResults.length) {
                        this.$message.warning('请先执行搜索获取结果');
                        return;
                    }
                    if (!this.statistics.xAxis || !this.statistics.yAxis) {
                        this.$message.warning('请选择统计维度');
                        return;
                    }
                    
                    // TODO: 这里添加统计逻辑
                    console.log('开始统计', this.statistics);
                    this.$message.info('统计功能开发中...');
                },
                resetForm() {
                    this.searchLevels = [{
                        keywords: '',
                        column_name: ['问题描述'],
                        logic: 'and',
                        negative_filtering: false
                    }];
                    this.contentSearch.text = '';
                    this.contentSearch.selectedColumns = ['问题描述'];
                    this.aiInput = '';
                    this.aiResult = '';
                    this.searchResults = [];
                    this.total = 0;
                    
                    // 移除相似度列
                    const similarityIndex = this.columns.indexOf('相似度');
                    if (similarityIndex > -1) {
                        this.columns.splice(similarityIndex, 1);
                        delete this.columnVisible['相似度'];
                    }
                    this.selectedRows = [];
                },
                exportToCsv() {
                    if (!this.selectedRows.length) {
                        this.$message.warning('请先选择要导出的数据');
                        return;
                    }
                    
                    const visibleCols = this.visibleColumns;
                    
                    let csvContent = '\uFEFF';  // 添加BOM标记以支持中文
                    
                    // 添加表头
                    csvContent += visibleCols.join(',') + '\n';
                    
                    // 只导出选中的行
                    this.selectedRows.forEach(row => {
                        const rowData = visibleCols.map(col => {
                            let cellData = row[col] || '';
                            // 处理单元格数据，确保CSV格式正确
                            cellData = cellData.toString().replace(/"/g, '""');
                            if (cellData.includes(',') || cellData.includes('\n') || cellData.includes('"')) {
                                cellData = `"${cellData}"`;
                            }
                            return cellData;
                        });
                        csvContent += rowData.join(',') + '\n';
                    });
                    
                    // 创建并下载文件
                    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8' });
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(blob);
                    link.download = `搜索结果_${new Date().toLocaleString()}.csv`;
                    
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    this.$message.success(`成功导出 ${this.selectedRows.length} 条记录`);
                },
                showSearchColumnsDialog() {
                    this.searchColumnsDialogVisible = true;
                },
                applySearchColumnSettings() {
                    this.searchColumnsDialogVisible = false;
                },
                handleSelectAllChange(val) {
                    // 处理全选/取消全选
                    this.selectedColumns = val ? [...this.columns] : [];
                },
                handleSelectedChange(value) {
                    // 处理选中列变化
                    this.selectAll = value.length === this.columns.length;
                },
                showDataSourceDialog() {
                    // 记录打开对话框时的数据源，用于后续比较
                    this.tempDataSource = this.defaultSearch.dataSource;
                    this.dataSourceDialogVisible = true;
                },
                async applyDataSourceSettings() {
                    const oldDataSource = this.tempDataSource;  // 使用临时存储的旧数据源
                    const newDataSource = this.defaultSearch.dataSource;
                    this.dataSourceDialogVisible = false;
                    
                    if (oldDataSource !== newDataSource) {
                        try {
                            // 1. 先更新数据源相关数据
                            await this.updateDataSource(newDataSource);
                            
                            // 2. 如果更新成功，显示切换成功提示
                            this.$notify({
                                title: '成功',
                                message: `数据源已切换至${this.dataSourceOptions[newDataSource]}`,
                                type: 'success',
                                duration: 2000,
                                position: 'top-right'
                            });
                        } catch (error) {
                            // 如果更新失败，回退到原来的数据源
                            this.defaultSearch.dataSource = oldDataSource;
                            this.$notify.error({
                                title: '错误',
                                message: '切换数据源失败，已恢复原数据源',
                                duration: 3000,
                                position: 'top-right'
                            });
                        }
                    }
                },
                async updateDataSource(value) {
                    try {
                        // 1. 更新默认搜索列
                        const defaultColumn = this.defaultSearchColumn[value];
                        this.searchLevels.forEach(level => {
                            level.column_name = [defaultColumn];
                        });

                        // 2. 更新相似度搜索的默认选中列
                        if (value === 'engineering') {
                            this.contentSearch.selectedColumns = ['原因和说明'];
                        } else {
                            this.contentSearch.selectedColumns = ['问题描述'];  // 故障报告默认选中"问题描述"
                        }

                        // 3. 移除相似度列
                        const similarityIndex = this.columns.indexOf('相似度');
                        if (similarityIndex > -1) {
                            this.columns.splice(similarityIndex, 1);
                            delete this.columnVisible['相似度'];
                        }

                        // 4. 获取新数据源的数据类型
                        const response = await fetch(`/api/data_types/${value}`);
                        const data = await response.json();
                        if (data.status === 'success') {
                            this.availableDataTypes = data.types;
                            this.defaultSearch.dataTypes = [...data.types];
                        }

                        // 5. 更新列显示
                        await this.loadDataSourceColumns();
                        
                        // 6. 清空搜索结果
                        this.searchResults = [];
                        this.total = 0;
                    } catch (error) {
                        console.error('更新数据源失败:', error);
                        throw error;
                    }
                },
                showDataTypesDialog() {
                    this.selectAllDataTypes = this.defaultSearch.dataTypes.length === this.availableDataTypes.length;
                    this.dataTypesDialogVisible = true;
                },
                applyDataTypesSettings() {
                    // 保存之前的选择
                    const oldTypes = [...this.defaultSearch.dataTypes];
                    this.dataTypesDialogVisible = false;
                    
                    // 如果选择发生变化，可以在这里添加处理逻辑
                    if (JSON.stringify(oldTypes) !== JSON.stringify(this.defaultSearch.dataTypes)) {
                        // 可以触发搜索或其他操作
                        console.log('数据类型选择已更新:', this.defaultSearch.dataTypes);
                    }
                },
                showAircraftTypesDialog() {
                    this.selectAllAircraftTypes = this.defaultSearch.aircraftTypes.length === this.aircraftTypeOptions.length;
                    this.aircraftTypesDialogVisible = true;
                },
                applyAircraftTypesSettings() {
                    // 保存之前的选择
                    const oldTypes = [...this.defaultSearch.aircraftTypes];
                    this.aircraftTypesDialogVisible = false;
                    
                    // 如果选择发生变化，可以在这里添加处理逻辑
                    if (JSON.stringify(oldTypes) !== JSON.stringify(this.defaultSearch.aircraftTypes)) {
                        // 可以触发搜索或其他操作
                        console.log('机型选择已更新:', this.defaultSearch.aircraftTypes);
                    }
                },
                handleSelectAllDataTypes(val) {
                    this.defaultSearch.dataTypes = val ? [...this.availableDataTypes] : [];
                },
                handleSelectAllAircraftTypes(val) {
                    this.defaultSearch.aircraftTypes = val ? [...this.aircraftTypeOptions] : [];
                },
                async anonymizeResults() {
                    try {
                        if (!this.searchResults.length) {
                            this.$message.warning('没有可脱敏的搜索结果');
                            return;
                        }
                        
                        // 根据数据源确定需要脱敏的字段
                        let fieldsToAnonymize;
                        if (this.defaultSearch.dataSource === 'engineering') {
                            fieldsToAnonymize = ['原因和说明', '原文文本', '文件名称'];
                        } else if (this.defaultSearch.dataSource === 'faults') {
                            fieldsToAnonymize = ['问题描述', '排故措施'];
                        } else {
                            fieldsToAnonymize = ['标题', '问题描述', '答复详情', '客户期望', '机号/MSN', '运营人'];  // 更新快响信息的脱敏字段
                        }
                        
                        fetch('/api/anonymize', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                results: this.searchResults,
                                fields: fieldsToAnonymize,
                                dataSource: this.defaultSearch.dataSource
                            })
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.status === 'success') {
                                this.searchResults = data.data;
                                this.$message.success('脱敏处理完成');
                            } else {
                                throw new Error(data.message);
                            }
                        })
                        .catch(error => {
                            this.$message.error('脱敏处理失败：' + error.message);
                        });
                    } catch (error) {
                        this.$message.error('脱敏处理失败：' + error.message);
                    }
                },
                showSensitiveWordDialog() {
                    this.loadSensitiveWords();
                    this.sensitiveWordDialogVisible = true;
                },
                loadSensitiveWords() {
                    console.log('开始加载敏感词列表');
                    fetch('/api/sensitive_words')
                        .then(response => {
                            if (!response.ok) {
                                throw new Error(`HTTP error! status: ${response.status}`);
                            }
                            console.log('API响应状态:', response.status); // 添加状态码日志
                            return response.json();
                        })
                        .then(data => {
                            console.log('API返回的完整数据:', data); // 添加完整响应数据日志
                            if (data.status === 'success') {
                                this.sensitiveWords = data.words;
                                console.log('成功加载敏感词列表:', this.sensitiveWords);
                                
                                // 检查数据结构
                                if (Object.keys(this.sensitiveWords).length === 0) {
                                    console.warn('警告：敏感词列表为空对象');
                                }
                            } else {
                                throw new Error(data.message || '加载失败');
                            }
                        })
                        .catch(error => {
                            console.error('加载敏感词失败:', error);
                            this.$message.error('加载敏感词失败：' + error.message);
                        });
                },
                addSensitiveWord() {
                    if (!this.newWord.trim()) {
                        this.$message.warning('请输入敏感词');
                        return;
                    }
                    
                    const word = this.newWord.trim();
                    
                    // 检查所有类别中是否已存在该敏感词
                    const isWordExists = Object.values(this.sensitiveWords).some(
                        categoryWords => categoryWords.some(item => item.word === word)
                    );
                    
                    if (isWordExists) {
                        this.$message.error('该敏感词已存在于词库中');
                        return;
                    }
                    
                    console.log('正在添加敏感词:', {
                        word: word,
                        category: this.selectedCategory
                    });
                    
                    fetch('/api/sensitive_words', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            word: word,
                            category: this.selectedCategory
                        })
                    })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        if (data.status === 'success') {
                            this.$message.success('敏感词添加成功');
                            this.newWord = '';  // 清空输入
                            this.loadSensitiveWords();  // 重新加载敏感词列表
                        } else {
                            throw new Error(data.message || '添加失败');
                        }
                    })
                    .catch(error => {
                        console.error('添加敏感词失败:', error);
                        this.$message.error('添加敏感词失败：' + error.message);
                    });
                },
                removeSensitiveWord(word, category) {
                    this.$confirm('确定要删除这个敏感词吗？', '提示', {
                        type: 'warning'
                    }).then(() => {
                        fetch('/api/sensitive_words', {
                            method: 'DELETE',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                word: word,
                                category: category
                            })
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.status === 'success') {
                                this.$message.success('删除成功');
                                this.loadSensitiveWords();
                            } else {
                                throw new Error(data.message);
                            }
                        })
                        .catch(error => {
                            this.$message.error('删除失败：' + error.message);
                        });
                    }).catch(() => {});
                },
                countResultsByType(results) {
                    const typeCount = {};
                    
                    results.forEach(item => {
                        // 根据实际数据结构调整属性名
                        const type = item['数据类型'] || '未分类';
                        typeCount[type] = (typeCount[type] || 0) + 1;
                    });
                    
                    return typeCount;
                },
                handleColumnSelectChange(value, level) {
                    // 检查是否选择了全选选项
                    const selectAllIndex = value.indexOf('__select_all__');
                    if (selectAllIndex > -1) {
                        // 移除全选选项
                        value.splice(selectAllIndex, 1);
                        
                        // 获取当前数据源的所有列
                        const allColumns = this.dataSourceColumns[this.defaultSearch.dataSource] || [];
                        
                        // 如果当前选中的列数等于总列数（已经全选），则清空选择
                        if (value.length >= allColumns.length) {
                            level.column_name = [];
                        } else {
                            // 否则全选所有列
                            level.column_name = [...allColumns];
                        }
                    } else {
                        // 正常更新选中的列
                        level.column_name = value;
                    }
                },
                handleSelectionChange(selection) {
                    this.selectedRows = selection;
                },
                handleRowClick(row, column, event) {
                    // 获取当前点击行的索引
                    const currentIndex = this.searchResults.indexOf(row);
                    
                    if (event.shiftKey && this.lastClickedRowIndex !== null) {
                        // 如果按住shift键且有上次点击的行记录
                        // 计算需要选择的行范围
                        const start = Math.min(this.lastClickedRowIndex, currentIndex);
                        const end = Math.max(this.lastClickedRowIndex, currentIndex);
                        
                        // 选择范围内的所有行
                        for (let i = start; i <= end; i++) {
                            const rowToSelect = this.searchResults[i];
                            if (!this.selectedRows.includes(rowToSelect)) {
                                this.$refs.dataTable.toggleRowSelection(rowToSelect, true);
                            }
                        }
                    } else {
                        // 普通点击，切换当前行的选择状态
                        this.$refs.dataTable.toggleRowSelection(row);
                        // 更新最后点击的行索引
                        this.lastClickedRowIndex = currentIndex;
                    }
                },
                getRowClass({ row }) {
                    // 检查这一行是否在选中的行数组中
                    return this.selectedRows.includes(row) ? 'selected-row' : '';
                },
                analyzeSelectedData() {
                    if (!this.selectedRows.length) {
                        this.$message.warning('请先选择要分析的数据');
                        return;
                    }

                    // 将数据存储在浏览器的 localStorage 中
                    localStorage.setItem('analysisData', JSON.stringify({
                        data: this.selectedRows,
                        columns: this.visibleColumns,
                        dataSource: this.defaultSearch.dataSource
                    }));

                    // 打开新页面，不带数据参数
                    window.open('/analysis', '_blank');
                },
                showImportDialog() {
                    this.importSettings.dataSource = this.defaultSearch.dataSource;  // 默认使用当前选择的数据源
                    this.importDialogVisible = true;
                },
                handleBeforeUpload(file) {
                    // 检查文件类型
                    const validTypes = ['application/vnd.ms-excel', 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet', 'text/csv'];
                    const isValidType = validTypes.includes(file.type);
                    
                    if (!isValidType) {
                        this.$message.error('只能上传 Excel 或 CSV 文件！');
                        return false;
                    }
                    
                    // 检查文件大小（限制为10MB）
                    const isLt10M = file.size / 1024 / 1024 < 10;
                    if (!isLt10M) {
                        this.$message.error('文件大小不能超过 10MB！');
                        return false;
                    }
                    
                    // 清除之前的预览数据
                    this.importSettings.previewData = null;
                    this.importSettings.uploadedFile = file;
                    
                    return true;
                },
                handleUploadSuccess(response, file, fileList) {
                    if (response.status === 'success') {
                        // 更新预览数据并保存temp_id
                        this.importSettings.previewData = {
                            original_count: response.data.original_count,
                            uploaded_count: response.data.uploaded_count,
                            duplicate_count: response.data.duplicate_count,
                            new_count: response.data.new_count,
                            final_count: response.data.final_count,
                            temp_id: response.temp_id  // 保存temp_id
                        };
                        this.$notify({
                            title: '上传成功',
                            message: '文件已上传，请确认数据预览',
                            type: 'success',
                            duration: 3000
                        });
                    } else {
                        this.$notify.error({
                            title: '上传失败',
                            message: response.message || '未知错误',
                            duration: 4000
                        });
                    }
                },
                handleUploadError(err, file, fileList) {
                    this.$notify.error({
                        title: '上传失败',
                        message: err.message || '文件上传失败',
                        duration: 4000
                    });
                },
                cancelImport() {
                    // 发送取消请求，清理临时文件
                    if (this.importSettings.previewData && this.importSettings.previewData.temp_id) {
                        fetch('/api/cancel_import', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                dataSource: this.importSettings.dataSource,
                                temp_id: this.importSettings.previewData.temp_id  // 添加temp_id
                            })
                        });
                    }
                    this.importSettings.previewData = null;
                    this.importSettings.uploadedFile = null;
                    this.importDialogVisible = false;
                },
                confirmImport() {
                    if (!this.importSettings.previewData) {
                        this.$message.warning('请先上传文件');
                        return;
                    }

                    this.$confirm('确认要导入这些数据吗？', '确认导入', {
                        confirmButtonText: '确定',
                        cancelButtonText: '取消',
                        type: 'warning'
                    }).then(() => {
                        // 发送确认导入请求
                        fetch('/api/confirm_import', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                dataSource: this.importSettings.dataSource,
                                temp_id: this.importSettings.previewData.temp_id  // 添加temp_id
                            })
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.status === 'success') {
                                this.$notify({
                                    title: '导入成功',
                                    message: '数据已成功更新',
                                    type: 'success',
                                    duration: 3000
                                });
                                this.importDialogVisible = false;
                                this.importSettings.previewData = null;
                                this.importSettings.uploadedFile = null;
                            } else {
                                throw new Error(data.message || '导入失败');
                            }
                        })
                        .catch(error => {
                            this.$notify.error({
                                title: '导入失败',
                                message: error.message,
                                duration: 4000
                            });
                        });
                    }).catch(() => {});
                },
                handleAnalysis() {
                    // 确保有选中的数据
                    if (this.selectedRows.length === 0) {
                        this.$message.warning('请先选择要分析的数据');
                        return;
                    }

                    // 保存数据到 localStorage
                    localStorage.setItem('analysisData', JSON.stringify({
                        data: this.selectedRows,
                        columns: Object.keys(this.selectedRows[0]),
                        dataSource: this.defaultSearch.dataSource
                    }));

                    // 在新窗口打开分析页面
                    window.open('/analysis', '_blank');
                }
            }
        })
    </script>
</body>
</html> 