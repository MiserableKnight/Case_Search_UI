<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>历史问题查询系统</title>
    <!-- 引入 Element UI -->
    <link rel="stylesheet" href="https://unpkg.com/element-ui/lib/theme-chalk/index.css">
    <style>
        body {
            margin: 0;
            padding: 0;
            background-color: #f5f7fa;
        }
        .container {
            max-width: 100%;
            margin: 0;
            padding: 20px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        .search-section {
            margin-bottom: 20px;
            padding: 20px;
            background-color: white;
            border-radius: 4px;
            box-shadow: 0 2px 12px 0 rgba(0,0,0,0.1);
            display: flex;
            gap: 20px;
        }
        .search-block {
            flex: 1;
            min-width: 0;
            border: 1px solid #EBEEF5;
            border-radius: 4px;
            padding: 15px;
        }
        .block-title {
            font-size: 16px;
            color: #303133;
            margin-bottom: 15px;
            font-weight: bold;
        }
        .result-section {
            flex: 1;
            background-color: white;
            border-radius: 4px;
            box-shadow: 0 2px 12px 0 rgba(0,0,0,0.1);
            padding: 20px;
            margin-top: 20px;
        }
        .el-table {
            margin-top: 10px;
            font-size: 13px;
        }
        /* 添加自定义的表格行悬停效果 */
        .el-table__body tr:hover > td {
            background-color: #e6f1fc !important;  /* 更深的蓝色调背景 */
        }
        .result-info {
            margin: 10px 0;
            color: #606266;
            font-size: 14px;
            font-weight: bold;
        }
        h1 {
            margin-bottom: 20px;
            color: #303133;
        }
        .el-table__body-wrapper {
            overflow-y: auto;
        }
        .el-table th {
            font-size: 13px;
            padding: 4px 0;
        }
        .el-table td {
            padding: 2px 4px;
            font-size: 12px;
            vertical-align: top !important;
        }
        .el-table .cell {
            line-height: 18px;
            white-space: pre-wrap !important;
            height: auto !important;
            word-break: break-all;
            padding-top: 4px !important;
        }
        .search-cards {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .search-card {
            position: relative;
            border: 1px solid #EBEEF5;
            border-radius: 4px;
            padding: 10px;
            background: white;
        }
        .search-content {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .search-content .el-input {
            width: 200px;
        }
        .search-content .el-select {
            width: 120px;
        }
        .card-actions {
            position: absolute;
            right: 5px;
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            gap: 5px;
        }
        .action-btn {
            padding: 4px;
            cursor: pointer;
            color: #909399;
            transition: color 0.3s;
        }
        .action-btn:hover {
            color: #409EFF;
        }
        .action-btn.delete:hover {
            color: #F56C6C;
        }
        .buttons-section {
            margin-top: 15px;
            display: flex;
            justify-content: center;
            gap: 10px;
        }
        .content-search {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .content-search .el-input {
            width: 100%;
        }
        .similarity-btn {
            align-self: flex-end;
        }
        .ai-summary {
            display: flex;
            flex-direction: column;
            gap: 10px;
            height: 100%;
        }
        .ai-summary .el-input {
            flex: 1;
        }
        .ai-input {
            height: 80px;
        }
        .ai-output {
            flex: 1;
            min-height: 120px;
        }
        .column-control {
            margin-bottom: 10px;
            display: flex;
            align-items: center;
        }
        .column-control .el-dropdown {
            margin-right: 10px;
        }
        .column-dropdown-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 5px 10px;
        }
        .column-dropdown-item .el-checkbox {
            margin-right: 0;
        }
        .search-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
    </style>
</head>
<body>
    <div id="app">
        <div class="container">
            <h1>历史问题查询系统</h1>
            
            <!-- 搜索区域 -->
            <div class="search-section">
                <!-- 关键字搜索 -->
                <div class="search-block">
                    <div class="block-title">关键字搜索</div>
                    <div class="search-cards">
                        <div v-for="(level, idx) in searchLevels" :key="idx" class="search-card">
                            <div class="search-content">
                                <el-input v-model="level.keywords" placeholder="请输入关键字"></el-input>
                                <el-select v-model="level.column_name" placeholder="搜索列">
                                    <el-option label="全部列" :value="['all']"></el-option>
                                    <el-option
                                        v-for="col in columns"
                                        :key="col"
                                        :label="col"
                                        :value="col">
                                    </el-option>
                                </el-select>
                                <el-radio-group v-model="level.logic">
                                    <el-radio label="and">与</el-radio>
                                    <el-radio label="or">或</el-radio>
                                </el-radio-group>
                                <el-switch v-model="level.negative_filtering"></el-switch>
                            </div>
                            <div class="card-actions">
                                <span v-if="idx === 0" class="action-btn" @click="addLevel" title="添加搜索条件">
                                    <i class="el-icon-plus"></i>
                                </span>
                                <span v-if="idx > 0" class="action-btn delete" @click="removeLevel(idx)" title="删除">
                                    <i class="el-icon-close"></i>
                                </span>
                            </div>
                        </div>
                    </div>
                    <div class="buttons-section">
                        <el-button type="primary" @click="handleSearch">搜索</el-button>
                        <el-button @click="resetForm">重置</el-button>
                    </div>
                </div>

                <!-- 按内容搜索 -->
                <div class="search-block">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <div class="block-title" style="margin-bottom: 0;">按相似度搜索</div>
                        <el-button type="primary" size="small" @click="showSearchColumnsDialog">
                            搜索范围设置<i class="el-icon-setting el-icon--right"></i>
                        </el-button>
                    </div>
                    <div class="content-search">
                        <el-input
                            type="textarea"
                            :rows="6"
                            placeholder="请输入要搜索的内容"
                            v-model="contentSearch.text">
                        </el-input>
                        <div style="text-align: right;">
                            <el-button type="primary" @click="handleSimilaritySearch" :disabled="!contentSearch.selectedColumns.length">
                                开始搜索
                            </el-button>
                        </div>
                    </div>
                </div>

                <!-- AI总结 -->
                <div class="search-block">
                    <div class="block-title">AI总结</div>
                    <div class="content-search">
                        <el-input
                            type="textarea"
                            :rows="6"
                            placeholder="请输入您的分析需求（例如：总结这些案例的共同特点和解决方案）"
                            v-model="aiInput">
                        </el-input>
                        <el-button 
                            type="primary" 
                            class="similarity-btn" 
                            @click="handleAiAnalysis"
                            :disabled="!searchResults.length || !aiInput.trim()">
                            开始分析
                        </el-button>
                    </div>
                </div>
            </div>

            <!-- 结果区域 -->
            <div class="result-section" v-if="total > 0">
                <!-- 结果信息 -->
                <div class="result-info">
                    找到 [[ total ]] 条匹配记录
                </div>

                <!-- 结果表格 -->
                <div class="column-control">
                    <el-button type="primary" size="small" @click="showColumnDialog">
                        列显示控制<i class="el-icon-setting el-icon--right"></i>
                    </el-button>
                    <el-button type="success" size="small" @click="exportToCSV" :disabled="!searchResults.length">
                        导出CSV
                    </el-button>
                </div>

                <!-- 列显示控制对话框 -->
                <el-dialog title="列显示控制" :visible.sync="columnDialogVisible" width="300px">
                    <div style="max-height: 400px; overflow-y: auto;">
                        <el-checkbox-group v-model="selectedColumns">
                            <div v-for="col in columns" :key="col" style="margin-bottom: 10px;">
                                <el-checkbox :label="col">[[ col ]]</el-checkbox>
                            </div>
                        </el-checkbox-group>
                    </div>
                    <span slot="footer" class="dialog-footer">
                        <el-button @click="columnDialogVisible = false">取消</el-button>
                        <el-button type="primary" @click="applyColumnSettings">确定</el-button>
                    </span>
                </el-dialog>

                <!-- 搜索范围设置对话框 -->
                <el-dialog title="搜索范围设置" :visible.sync="searchColumnsDialogVisible" width="300px">
                    <div style="max-height: 400px; overflow-y: auto;">
                        <el-checkbox-group v-model="contentSearch.selectedColumns">
                            <div v-for="col in searchableColumns" :key="col" style="margin-bottom: 10px;">
                                <el-checkbox :label="col">[[ col ]]</el-checkbox>
                            </div>
                        </el-checkbox-group>
                    </div>
                    <span slot="footer" class="dialog-footer">
                        <el-button @click="searchColumnsDialogVisible = false">取消</el-button>
                        <el-button type="primary" @click="applySearchColumnSettings">确定</el-button>
                    </span>
                </el-dialog>

                <el-table
                    v-loading="loading"
                    :data="searchResults"
                    style="width: 100%"
                    size="mini">
                    <el-table-column
                        v-for="col in visibleColumns"
                        :key="col"
                        :prop="col"
                        :label="col"
                        :min-width="getColumnWidth(col)"
                        :width="getColumnFixedWidth(col)"
                        resizable>
                    </el-table-column>
                </el-table>
            </div>

            <!-- AI分析结果弹窗 -->
            <el-dialog
                title="AI分析结果"
                :visible.sync="aiDialogVisible"
                width="50%"
                :close-on-click-modal="false"
                :close-on-press-escape="false">
                <div style="max-height: 60vh; overflow-y: auto; white-space: pre-wrap; user-select: text;">
                    [[ aiResult ]]
                </div>
                <span slot="footer" class="dialog-footer">
                    <el-button type="primary" @click="aiDialogVisible = false">关闭</el-button>
                </span>
            </el-dialog>
        </div>
    </div>

    <!-- 引入 Vue 和 Element UI -->
    <script src="https://unpkg.com/vue@2/dist/vue.js"></script>
    <script src="https://unpkg.com/element-ui/lib/index.js"></script>
    <script src="https://unpkg.com/element-ui/lib/umd/locale/zh-CN.js"></script>
    <script>
        ELEMENT.locale(ELEMENT.lang.zhCN)
        
        new Vue({
            el: '#app',
            delimiters: ['[[', ']]'],
            data() {
                return {
                    searchLevels: [{
                        keywords: '21,无',
                        column_name: '机型',
                        logic: 'or',
                        negative_filtering: false
                    }, {
                        keywords: '',
                        column_name: '问题描述',
                        logic: 'and',
                        negative_filtering: false
                    }],
                    contentSearch: {
                        text: '',
                        selectedColumns: ['问题描述'] // 默认选中"问题描述"
                    },
                    aiInput: '',
                    loading: false,
                    searchResults: [],
                    total: 0,
                    columns: [],
                    columnVisible: {},
                    selectedColumns: [],  // 临时存储选中的列
                    columnDialogVisible: false,  // 控制对话框显示
                    aiDialogVisible: false,  // 控制AI结果弹窗显示
                    aiResult: '',  // 存储AI分析结果
                    defaultVisibleColumns: ['申请时间', '问题描述', '答复详情', '飞机序列号/注册号/运营人'],  // 新增：默认显示的列
                    importantColumns: ['问题描述', '答复详情'],
                    compactColumns: ['ATA', '版本号'],
                    searchColumnsDialogVisible: false,  // 控制搜索范围设置对话框显示
                    searchableColumns: ['标题', '问题描述', '答复详情', '客户期望']
                }
            },
            computed: {
                visibleColumns() {
                    return this.columns.filter(col => this.columnVisible[col]);
                }
            },
            created() {
                this.getColumns();
                console.log('应用已初始化');
            },
            methods: {
                getColumnWidth(column) {
                    if (this.importantColumns.includes(column)) {
                        return '300';
                    }
                    return '100';
                },
                getColumnFixedWidth(column) {
                    if (this.compactColumns.includes(column)) {
                        return '60';
                    }
                    return null;
                },
                getColumns() {
                    console.log('开始获取列名');
                    fetch('/api/columns')
                        .then(response => response.json())
                        .then(data => {
                            console.log('获取到的列名:', data);
                            if (data.status === 'success') {
                                this.columns = data.columns;
                                // 初始化列的可见性
                                this.columns.forEach(col => {
                                    this.$set(this.columnVisible, col, this.defaultVisibleColumns.includes(col));
                                });
                            }
                        })
                        .catch(error => {
                            console.error('获取列名失败:', error);
                            this.$message.error('获取列名失败：' + error);
                        });
                },
                showColumnDialog() {
                    // 初始化选中的列
                    this.selectedColumns = this.visibleColumns;
                    this.columnDialogVisible = true;
                },
                applyColumnSettings() {
                    // 应用列设置
                    this.columns.forEach(col => {
                        this.$set(this.columnVisible, col, this.selectedColumns.includes(col));
                    });
                    this.columnDialogVisible = false;
                },
                addLevel() {
                    this.searchLevels.push({
                        keywords: '',
                        column_name: ['all'],
                        logic: 'and',
                        negative_filtering: false
                    });
                },
                removeLevel(index) {
                    this.searchLevels.splice(index, 1);
                },
                handleSearch() {
                    console.log('开始搜索，搜索条件:', this.searchLevels);
                    if (!this.validateSearchLevels()) {
                        return;
                    }
                    this.loading = true;
                    
                    const searchData = {
                        search_levels: this.searchLevels
                    };
                    console.log('发送的搜索数据:', searchData);
                    
                    fetch('/api/search', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(searchData)
                    })
                    .then(response => {
                        console.log('收到响应:', response);
                        return response.json();
                    })
                    .then(data => {
                        console.log('搜索结果:', data);
                        if (data.status === 'success') {
                            this.searchResults = data.data;
                            this.total = data.total;
                            this.$message.success(`找到 ${this.total} 条匹配记录`);
                        } else {
                            this.$message.error(data.message);
                        }
                    })
                    .catch(error => {
                        console.error('搜索错误:', error);
                        this.$message.error('搜索失败：' + error);
                    })
                    .finally(() => {
                        this.loading = false;
                    });
                },
                validateSearchLevels() {
                    let isValid = true;
                    this.searchLevels.forEach((level, index) => {
                        if (!level.keywords || !level.keywords.trim()) {
                            this.$message.warning(`第${index + 1}重搜索的关键字不能为空`);
                            isValid = false;
                        }
                    });
                    return isValid;
                },
                handleSimilaritySearch() {
                    if (!this.contentSearch.text.trim()) {
                        this.$message.warning('请输入要搜索的内容');
                        return;
                    }
                    if (!this.searchResults.length) {
                        this.$message.warning('请先执行关键字搜索获取结果');
                        return;
                    }
                    if (!this.contentSearch.selectedColumns.length) {
                        this.$message.warning('请选择搜索范围');
                        this.searchColumnsDialogVisible = false;
                        return;
                    }

                    this.loading = true;
                    const searchText = this.contentSearch.text.trim();

                    try {
                        // 发送相似度搜索请求到后端
                        fetch('/api/similarity', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                text: searchText,
                                columns: this.contentSearch.selectedColumns,
                                results: this.searchResults
                            })
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.status === 'success') {
                                // 更新搜索结果
                                this.searchResults = data.data;
                                
                                // 确保相似度列显示在表格中
                                if (!this.columns.includes('相似度')) {
                                    this.columns.unshift('相似度');
                                    this.$set(this.columnVisible, '相似度', true);
                                }
                                
                                this.$message.success(`已按相似度排序 ${this.searchResults.length} 条记录`);
                            } else {
                                this.$message.error(data.message);
                            }
                        })
                        .catch(error => {
                            console.error('相似度计算错误:', error);
                            this.$message.error('相似度计算失败：' + error.message);
                        })
                        .finally(() => {
                            this.loading = false;
                        });
                    } catch (error) {
                        console.error('相似度计算错误:', error);
                        this.$message.error('相似度计算失败：' + error.message);
                        this.loading = false;
                    }
                },
                handleAiAnalysis() {
                    if (!this.searchResults.length) {
                        this.$message.warning('请先执行搜索获取结果');
                        return;
                    }
                    if (!this.aiInput.trim()) {
                        this.$message.warning('请输入分析需求');
                        return;
                    }
                    
                    this.loading = true;
                    fetch('/api/analyze', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            query: this.aiInput,
                            results: this.searchResults
                        })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            this.aiResult = data.summary;
                            this.aiDialogVisible = true;
                        } else {
                            this.$message.error(data.message);
                        }
                    })
                    .catch(error => {
                        this.$message.error('AI分析失败：' + error);
                    })
                    .finally(() => {
                        this.loading = false;
                    });
                },
                resetForm() {
                    this.searchLevels = [{
                        keywords: '21,无',
                        column_name: '机型',
                        logic: 'or',
                        negative_filtering: false
                    }, {
                        keywords: '',
                        column_name: '问题描述',
                        logic: 'and',
                        negative_filtering: false
                    }];
                    this.contentSearch.text = '';
                    this.contentSearch.selectedColumns = ['问题描述'];
                    this.aiInput = '';
                    this.aiResult = '';
                    this.searchResults = [];
                    this.total = 0;
                    
                    // 移除相似度列
                    const similarityIndex = this.columns.indexOf('相似度');
                    if (similarityIndex > -1) {
                        this.columns.splice(similarityIndex, 1);
                        delete this.columnVisible['相似度'];
                    }
                },
                exportToCSV() {
                    const visibleCols = this.visibleColumns;
                    
                    let csvContent = '\uFEFF';
                    
                    csvContent += visibleCols.join(',') + '\n';
                    
                    this.searchResults.forEach(row => {
                        const rowData = visibleCols.map(col => {
                            let cellData = row[col] || '';
                            cellData = cellData.toString().replace(/"/g, '""');
                            if (cellData.includes(',') || cellData.includes('\n') || cellData.includes('"')) {
                                cellData = `"${cellData}"`;
                            }
                            return cellData;
                        });
                        csvContent += rowData.join(',') + '\n';
                    });
                    
                    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8' });
                    
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(blob);
                    link.download = `搜索结果_${new Date().toLocaleString()}.csv`;
                    
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    this.$message.success('导出成功');
                },
                showSearchColumnsDialog() {
                    this.searchColumnsDialogVisible = true;
                },
                applySearchColumnSettings() {
                    this.searchColumnsDialogVisible = false;
                }
            }
        })
    </script>
</body>
</html> 